<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團隊日報管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { 50: '#f0f9ff', 100: '#e0f2fe', 600: '#0284c7', 800: '#075985' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .active-date { background-color: #e0f2fe; border-right: 4px solid #0284c7; color: #075985; font-weight: bold; }
        
        /* Button Styles */
        .header-tab-btn { 
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all duration-200 flex items-center gap-2 text-slate-500 whitespace-nowrap relative border border-transparent; 
        }
        
        /* State: Hover */
        .header-tab-btn:hover:not(.active) {
            @apply bg-slate-100 text-slate-700;
        }

        /* State: Active (Selected) - High Contrast */
        .header-tab-btn.active { 
            @apply bg-corp-600 text-white shadow-md; 
        }
        
        /* Data Dot Styling */
        .data-dot {
            @apply w-2 h-2 rounded-full transition-colors duration-300;
        }

        /* Logic for Active Tab Dots */
        .header-tab-btn.active.has-data .data-dot { @apply bg-emerald-300; }
        .header-tab-btn.active.no-data .data-dot { @apply bg-white; }

        /* Logic for Inactive Tab Dots */
        .header-tab-btn:not(.active).has-data .data-dot { @apply bg-emerald-500; }
        .header-tab-btn:not(.active).no-data .data-dot { @apply bg-slate-300; }


        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.expanded {
            max-height: 1000px; 
            opacity: 1;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-btn[aria-expanded="true"] .accordion-icon {
            transform: rotate(180deg);
        }

    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-800 flex">

    <!-- Sidebar: History & Tools -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col h-full shrink-0 shadow-lg z-20 hidden md:flex transition-all duration-300" id="mainSidebar">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-layer-group text-corp-600"></i> 日報管理系統
                </h1>
                <p class="text-xs text-slate-400 mt-1">Canvas Preview 版本</p>
            </div>
            <!-- Mobile close button -->
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div class="p-3">
            <button onclick="createNewReport()" class="w-full bg-corp-600 hover:bg-corp-800 text-white py-2 px-4 rounded-lg shadow text-sm font-bold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> 切換到當日
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll px-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2 mt-2">歷史紀錄</h3>
            <div id="historyList" class="space-y-1">
                <!-- JS Populated -->
            </div>
        </div>

        <div class="p-4 border-t border-slate-200 bg-slate-50">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">資料管理</h3>
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition" title="匯出 JSON">
                    <i class="fa-solid fa-download"></i> 備份
                </button>
                <label class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition text-center cursor-pointer" title="匯入 JSON">
                    <i class="fa-solid fa-upload"></i> 還原
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)" accept=".json">
                </label>
            </div>
            <button onclick="clearAllData()" class="w-full mt-2 text-rose-500 hover:text-rose-700 text-xs text-center underline">
                清空所有資料
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full">
        
        <!-- Toolbar Header -->
        <header class="bg-white border-b border-slate-200 p-3 md:p-4 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm z-10 shrink-0 gap-4 md:gap-0">
            <div class="flex items-center gap-4 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 custom-scroll no-scrollbar">
                <!-- Mobile Menu Toggle -->
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-800 p-1">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>

                <!-- Date Picker -->
                <div class="flex flex-col mr-2 shrink-0">
                    <label class="text-[10px] text-slate-400 font-bold uppercase leading-none mb-1">日報日期</label>
                    <input type="date" id="reportDatePicker" class="font-bold text-base text-slate-800 bg-transparent border-none p-0 focus:ring-0 cursor-pointer h-6 w-32" onchange="handleDateChange()">
                </div>

                <div class="hidden md:block h-8 w-px bg-slate-200 mx-2 shrink-0"></div>

                <!-- Tabs (Inline classes to ensure Flex layout works correctly) -->
                <div class="flex items-center bg-white rounded-lg border border-slate-200 p-1 shadow-sm shrink-0" id="tabContainer">
                    <button onclick="switchTab('ALL')" id="tab-ALL" class="header-tab-btn active">
                        <i class="fa-solid fa-chart-pie"></i> 總覽
                    </button>
                    
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>
                    
                    <button onclick="switchTab('TECH')" id="tab-TECH" class="header-tab-btn no-data">
                        <span class="data-dot"></span> 技術
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('QA')" id="tab-QA" class="header-tab-btn no-data">
                        <span class="data-dot"></span> 品檢
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('CS')" id="tab-CS" class="header-tab-btn no-data">
                        <span class="data-dot"></span> 客服
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('WEB')" id="tab-WEB" class="header-tab-btn no-data">
                        <span class="data-dot"></span> 網頁
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('ART')" id="tab-ART" class="header-tab-btn no-data">
                        <span class="data-dot"></span> 美術
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('DB')" id="tab-DB" class="header-tab-btn no-data">
                        <span class="data-dot"></span> DB
                    </button>
                </div>
            </div>

            <!-- Right Actions (Simplified) -->
            <div class="flex items-center gap-3 w-full md:w-auto justify-end mt-2 md:mt-0 shrink-0">
                <div id="headerTotalManHours" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full font-bold whitespace-nowrap">
                    尚未計算
                </div>
                <button onclick="saveCurrentReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> <span class="hidden md:inline">儲存</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 bg-slate-50">
            
            <!-- Missing Info Alert (Compressed Version) -->
            <div id="missingDataInfo" class="hidden bg-blue-50 border border-blue-100 rounded-lg py-2 px-3 flex items-center gap-2 shadow-sm mb-2">
                <i id="missingIcon" class="fa-solid fa-circle-info text-blue-500 text-sm shrink-0"></i>
                <span id="missingDataText" class="text-xs text-blue-700 font-medium truncate w-full">
                    目前所有組別皆已匯入資料。
                </span>
            </div>

            <!-- Editor / Input (Hidden in ALL tab) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-0 transition-all duration-300 overflow-hidden" id="inputSectionCard">
                <!-- Header -->
                <div class="bg-slate-50 border-b border-slate-200 px-4 md:px-6 py-3 flex justify-between items-center flex-wrap gap-2">
                    <div class="flex items-center gap-4">
                        <label class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                            <i class="fa-regular fa-keyboard text-slate-400"></i> 
                            <span id="inputLabelGroup">原始資料輸入</span> 
                        </label>
                        
                        <!-- Redmine / Google Sheet Source Toggle (QA Only) -->
                        <div id="qaSourceToggle" class="hidden flex items-center bg-slate-100 rounded-lg p-0.5 border border-slate-200">
                            <button onclick="setQaInputMode('MANUAL')" id="btn-qa-mode-manual" class="px-3 py-1 text-xs font-bold rounded-md transition-all bg-white text-corp-600 shadow-sm">手動輸入</button>
                            <button onclick="setQaInputMode('REDMINE')" id="btn-qa-mode-redmine" class="px-3 py-1 text-xs font-bold rounded-md transition-all text-slate-500 hover:text-slate-700">Redmine</button>
                            <button onclick="setQaInputMode('GSHEET')" id="btn-qa-mode-gsheet" class="px-3 py-1 text-xs font-bold rounded-md transition-all text-slate-500 hover:text-slate-700"><i class="fa-brands fa-google mr-1"></i>Sheet</button>
                        </div>

                        <!-- CS Leave Toggle (CS Only) -->
                        <div id="csSourceToggle" class="hidden flex items-center bg-slate-100 rounded-lg p-0.5 border border-slate-200">
                            <button onclick="setCsInputMode('MANUAL')" id="btn-cs-mode-manual" class="px-3 py-1 text-xs font-bold rounded-md transition-all bg-white text-corp-600 shadow-sm">手動輸入</button>
                            <button onclick="setCsInputMode('LEAVE')" id="btn-cs-mode-leave" class="px-3 py-1 text-xs font-bold rounded-md transition-all text-slate-500 hover:text-slate-700"><i class="fa-solid fa-mug-hot mr-1"></i>請假填寫</button>
                        </div>
                    </div>
                    
                    <!-- Tools -->
                    <div class="flex gap-2" id="inputTools">
                        <button onclick="parseData()" class="text-xs bg-corp-600 hover:bg-corp-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm">
                            <i class="fa-solid fa-rotate mr-1"></i> 解析資料
                        </button>
                        <button id="btnLoadDemo" onclick="loadDemo()" class="text-xs text-slate-400 hover:text-corp-600 hover:bg-slate-100 px-2 py-1 rounded transition border border-slate-200">
                            載入範例
                        </button>
                    </div>
                </div>

                <!-- Input Area Container -->
                <div id="inputAreaContainer" class="p-0 relative">
                    
                    <!-- Manual Textarea -->
                    <textarea id="rawInput" class="w-full h-48 p-4 border-none focus:ring-0 font-mono text-sm bg-white resize-y placeholder-slate-300 outline-none" placeholder="在此貼上日報內容..." oninput="handleInputUpdate()"></textarea>
                    
                    <!-- Redmine Importer UI (QA Only) -->
                    <div id="redmineImporter" class="hidden w-full h-48 p-4 bg-slate-50 flex flex-col gap-3 overflow-y-auto">
                         <div class="flex flex-wrap items-center gap-2 mb-2">
                             <span class="text-xs font-bold text-slate-600 uppercase bg-slate-200 px-2 py-1 rounded">API 設定</span>
                         </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                             <div>
                                 <label class="block text-xs font-bold text-slate-500 mb-1">API Key (權杖)</label>
                                 <input type="password" id="redmineKey" class="w-full border border-slate-300 rounded px-3 py-1.5 text-xs font-mono focus:outline-none focus:border-corp-600 transition" value="e040557087052db42b1016449bfb2f027cbbde78" placeholder="輸入 Redmine API Key">
                             </div>
                             <div>
                                 <label class="block text-xs font-bold text-slate-500 mb-1">Project ID (專案 ID)</label>
                                 <div class="flex gap-2">
                                     <input type="text" id="redmineProjectId" class="flex-1 border border-slate-300 rounded px-3 py-1.5 text-xs font-mono focus:outline-none focus:border-corp-600 transition" value="old_ts_test" placeholder="例如: old_ts_test">
                                     <button onclick="fetchRedmineData()" id="btnFetchRedmine" class="bg-corp-600 hover:bg-corp-700 text-white px-4 py-1.5 rounded text-xs font-bold shadow transition whitespace-nowrap">
                                         <i class="fa-solid fa-cloud-arrow-down mr-1"></i> 撈取工時
                                     </button>
                                 </div>
                             </div>
                         </div>
                         <div id="fetchStatusMsg" class="hidden mt-2 p-2 rounded text-xs"></div>
                         <div class="text-[10px] text-slate-400 mt-auto pt-2 border-t border-slate-200">
                             資料來源: https://igs.redmine-x.com/time_entries.json
                         </div>
                    </div>

                    <!-- Google Sheet Importer UI (QA Only) -->
                    <div id="gsheetImporter" class="hidden w-full h-48 p-4 bg-green-50/50 flex flex-col gap-3 overflow-y-auto">
                        <div class="flex flex-wrap items-center gap-2 mb-2 justify-between">
                            <span class="text-xs font-bold text-green-700 uppercase bg-green-100 px-2 py-1 rounded">Google Sheet 設定</span>
                            <span class="text-[10px] text-slate-400"><i class="fa-solid fa-triangle-exclamation mr-1"></i>需將試算表權限設為「知道連結者皆可檢視」</span>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Google Sheet ID (試算表 ID)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="gsheetId" class="flex-1 border border-slate-300 rounded px-3 py-1.5 text-xs font-mono focus:outline-none focus:border-green-600 transition" value="168G3AtI3lIdgIv6q75Fz9BtM_u11yC1G-cz1NTJApbo" placeholder="例如: 168G3AtI3lIdgIv6q75Fz9BtM_u11yC1G-cz1NTJApbo">
                                    <button onclick="fetchGoogleSheetData()" id="btnFetchGSheet" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-xs font-bold shadow transition whitespace-nowrap">
                                        <i class="fa-brands fa-google mr-1"></i> 匯入資料
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1 truncate">
                                    連結格式: https://docs.google.com/spreadsheets/d/<strong>{ID}</strong>/edit...
                                </p>
                            </div>
                        </div>
                        
                        <!-- Column Mapping (Collapsed / Small) -->
                        <div class="border-t border-green-200 pt-2 mt-1">
                            <div class="text-[10px] font-bold text-slate-400 mb-1">欄位對應 (Column Index: A=0, B=1, ...)</div>
                            <div class="flex gap-2 overflow-x-auto pb-1">
                                <input type="number" id="colDate" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Date" value="0" title="日期 (A)">
                                <input type="number" id="colName" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Name" value="1" title="姓名 (B)">
                                <input type="number" id="colProj" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Proj" value="2" title="專案 (C)">
                                <input type="number" id="colId" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="ID" value="3" title="議題ID (D)">
                                <input type="number" id="colCat" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Cat" value="3" title="類別 (E)">
                                <input type="number" id="colContent" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Cont" value="4" title="內容 (F)">
                                <input type="number" id="colHours" class="w-12 border rounded px-1 text-[10px] text-center" placeholder="Hrs" value="5" title="工時 (G)">
                            </div>
                        </div>

                        <div id="gsheetStatusMsg" class="hidden mt-1 p-2 rounded text-xs"></div>
                   </div>

                    <!-- CS Leave Importer UI (CS Only) -->
                    <div id="csLeaveImporter" class="hidden w-full h-48 bg-orange-50/30 flex flex-col overflow-hidden relative">
                        <!-- Input Row -->
                        <div class="p-4 pb-2 shrink-0">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold text-orange-600 uppercase bg-orange-100 px-2 py-1 rounded">請假登錄</span>
                                <span class="text-[10px] text-orange-400">登錄後的資料僅會顯示在右下角的「請假/未出勤明細」，不會合併到總覽列表。</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">姓名</label>
                                    <input type="text" id="csLeaveName" class="w-full border border-slate-300 rounded px-3 py-1.5 text-xs font-bold focus:outline-none focus:border-orange-500 transition" placeholder="例如: 王小明">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">請假事由</label>
                                    <input type="text" id="csLeaveReason" class="w-full border border-slate-300 rounded px-3 py-1.5 text-xs focus:outline-none focus:border-orange-500 transition" placeholder="例如: 病假 / 特休">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">時數</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="csLeaveHours" class="flex-1 border border-slate-300 rounded px-3 py-1.5 text-xs font-mono focus:outline-none focus:border-orange-500 transition" placeholder="8" step="0.5">
                                        <button onclick="addCsLeave()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow transition whitespace-nowrap">
                                            <i class="fa-solid fa-plus mr-1"></i> 新增
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Added List -->
                        <div class="flex-1 overflow-y-auto custom-scroll px-4 pb-4">
                            <div id="csLeaveListDisplay" class="space-y-1">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                   </div>

                </div>
            </section>

            <!-- Detail List & Export (Removed Copy Buttons) -->
            <section id="resultSection" class="hidden space-y-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b border-slate-200 pb-2 gap-2">
                    <h3 class="font-bold text-slate-700 text-lg">
                        <i class="fa-solid fa-list-check text-slate-400 mr-2"></i> 彙整結果 <span id="resultSectionTitleSuffix" class="text-sm text-slate-400 ml-2 font-normal"></span>
                    </h3>
                </div>
                <!-- Reduced spacing in container -->
                <div id="detailView" class="space-y-2"></div>
            </section>

            <!-- Dashboard Widgets (Moved Down) -->
            <div id="analysisSection" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 pb-10">
                <!-- Work Hours Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-2">
                            <i class="fa-solid fa-clock"></i>
                        </span>
                        工時統計
                        <span id="widgetTotalManHours" class="ml-auto text-xs bg-slate-100 px-2 py-1 rounded-full font-normal text-slate-500"></span>
                    </h3>
                    <div class="overflow-y-auto custom-scroll max-h-[250px]">
                        <table class="w-full text-sm">
                            <tbody id="hoursTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Leave Details -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center mr-2">
                            <i class="fa-solid fa-clipboard-user"></i>
                        </span>
                        請假 / 未出勤明細
                    </h3>
                    <div id="leaveListContainer" class="flex-1 overflow-y-auto custom-scroll max-h-[250px]"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // --- STORAGE & STATE MANAGER ---
        const DB_KEY = 'daily_reports_db_v4_expanded'; 
        let currentReportDate = '';
        
        // Data Model Definitions
        const ALL_GROUPS = ['TECH', 'QA', 'CS', 'WEB', 'ART', 'DB'];
        
        // currentDailyData structure updated to include separate leaves array
        // { TECH: '', ..., leaves: [ {id, group, name, reason, hours} ] }
        let currentDailyData = {
            TECH: '',
            QA: '',
            CS: '',
            WEB: '',
            ART: '',
            DB: '',
            leaves: [] 
        };
        let activeTab = 'ALL'; // Default to ALL
        let parsedData = [];
        let qaInputMode = 'MANUAL'; // 'MANUAL', 'REDMINE', 'GSHEET'
        let csInputMode = 'MANUAL'; // 'MANUAL' or 'LEAVE'

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            updateHistoryList();
            loadReportByDate(today);
        });

        // Sidebar Toggle Logic for Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('absolute', 'w-full', 'h-full', 'left-0', 'top-0');
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('absolute', 'w-full', 'h-full', 'left-0', 'top-0');
            }
        }

        function getDB() {
            const data = localStorage.getItem(DB_KEY);
            return data ? JSON.parse(data) : {};
        }

        function saveDB(data) {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            updateHistoryList();
        }

        // --- TAB LOGIC ---
        function updateTabUI() {
            // Check status of each group and update UI colors
            ALL_GROUPS.forEach(group => {
                const btn = document.getElementById(`tab-${group}`);
                if (!btn) return;
                const hasData = currentDailyData[group] && currentDailyData[group].trim().length > 0;
                
                if (hasData) {
                    btn.classList.add('has-data');
                    btn.classList.remove('no-data');
                } else {
                    btn.classList.add('no-data');
                    btn.classList.remove('has-data');
                }
            });
            updateMissingInfoText();
        }

        function updateMissingInfoText() {
            const missing = [];
            
            // Check all groups defined
            ALL_GROUPS.forEach(group => {
                if (!currentDailyData[group] || !currentDailyData[group].trim()) {
                    missing.push(getGroupName(group));
                }
            });

            const infoText = document.getElementById('missingDataText');
            const infoBox = document.getElementById('missingDataInfo');
            const icon = document.getElementById('missingIcon');
            
            if (missing.length === ALL_GROUPS.length) {
                // All empty
                infoText.innerHTML = '提示：尚無任何資料，請切換至各組別標籤進行輸入。';
                infoBox.className = "bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 flex items-center gap-2 shadow-sm mb-2";
                icon.className = "fa-solid fa-circle-info text-slate-400 text-sm shrink-0";
                infoText.className = "text-xs text-slate-500 font-medium truncate w-full";
            } else if (missing.length > 0) {
                // Some missing - Single line format
                let missingStr = missing.join('、');
                // Truncate if too long to keep single line, though flex usually handles it
                infoText.innerHTML = `提示：以下組別尚未匯入資料：<span class="font-bold">${missingStr}</span>`;
                infoBox.className = "bg-amber-50 border border-amber-100 rounded-lg py-2 px-3 flex items-center gap-2 shadow-sm mb-2";
                icon.className = "fa-solid fa-triangle-exclamation text-amber-500 text-sm shrink-0";
                infoText.className = "text-xs text-amber-700 font-medium truncate w-full";
            } else {
                // All done
                infoText.innerHTML = '提示：所有組別皆已完成資料匯入。';
                infoBox.className = "bg-emerald-50 border border-emerald-100 rounded-lg py-2 px-3 flex items-center gap-2 shadow-sm mb-2";
                icon.className = "fa-solid fa-check-circle text-emerald-500 text-sm shrink-0";
                infoText.className = "text-xs text-emerald-700 font-medium truncate w-full";
            }
        }

        function switchTab(tab) {
            activeTab = tab;

            // Update Header Tab Styles
            document.querySelectorAll('.header-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Elements
            const inputCard = document.getElementById('inputSectionCard');
            const missingInfo = document.getElementById('missingDataInfo');
            const textarea = document.getElementById('rawInput');
            const labelGroup = document.getElementById('inputLabelGroup');
            const titleSuffix = document.getElementById('resultSectionTitleSuffix');
            
            const qaSourceToggle = document.getElementById('qaSourceToggle');
            const csSourceToggle = document.getElementById('csSourceToggle');
            const inputTools = document.getElementById('inputTools');

            if (tab === 'ALL') {
                // Overview Mode
                inputCard.classList.add('hidden'); // Hide Input
                missingInfo.classList.remove('hidden'); // Show Info
                titleSuffix.innerText = "(全部總覽)";
                
                // Force a re-parse to ensure dashboard is up to date based on ALL data
                parseData(false);

            } else {
                // Group Input Mode
                inputCard.classList.remove('hidden'); // Show Input
                missingInfo.classList.add('hidden'); // Hide Info
                titleSuffix.innerText = `(${getGroupName(tab)})`;
                
                // Set Label & Textarea
                labelGroup.innerText = `${getGroupName(tab)} - 原始資料輸入`;
                textarea.value = currentDailyData[tab] || '';
                textarea.placeholder = `在此貼上【${getGroupName(tab)}】的 OLD_TS 原始資料...`;

                // --- Toggle Logic for QA and CS ---
                qaSourceToggle.classList.add('hidden');
                csSourceToggle.classList.add('hidden');
                
                // Default visibility reset
                document.getElementById('rawInput').classList.remove('hidden');
                document.getElementById('redmineImporter').classList.add('hidden');
                document.getElementById('gsheetImporter').classList.add('hidden');
                document.getElementById('csLeaveImporter').classList.add('hidden');
                inputTools.classList.remove('hidden');

                if (tab === 'QA') {
                    qaSourceToggle.classList.remove('hidden');
                    updateQaInputModeUI(); // Restore state
                } else if (tab === 'CS') {
                    csSourceToggle.classList.remove('hidden');
                    updateCsInputModeUI(); // Restore state
                }
                
                // Trigger parseData again to filter the view ONLY for this tab
                parseData(false);
                
                // Focus slightly delayed to allow UI update
                if(tab !== 'QA' && tab !== 'CS') {
                    setTimeout(() => textarea.focus(), 50);
                } else {
                    // Logic to focus based on mode
                    if(tab === 'QA' && qaInputMode === 'MANUAL') setTimeout(() => textarea.focus(), 50);
                    if(tab === 'CS' && csInputMode === 'MANUAL') setTimeout(() => textarea.focus(), 50);
                }
            }
        }

        // --- QA SPECIFIC LOGIC ---
        function setQaInputMode(mode) {
            qaInputMode = mode;
            updateQaInputModeUI();
        }

        function updateQaInputModeUI() {
            const btnManual = document.getElementById('btn-qa-mode-manual');
            const btnRedmine = document.getElementById('btn-qa-mode-redmine');
            const btnGSheet = document.getElementById('btn-qa-mode-gsheet');
            
            const rawInput = document.getElementById('rawInput');
            const redmineImporter = document.getElementById('redmineImporter');
            const gsheetImporter = document.getElementById('gsheetImporter');
            const inputTools = document.getElementById('inputTools');

            // Reset buttons
            [btnManual, btnRedmine, btnGSheet].forEach(btn => {
                btn.classList.remove('bg-white', 'text-corp-600', 'shadow-sm');
                btn.classList.add('text-slate-500');
            });
            
            // Reset sections
            rawInput.classList.add('hidden');
            redmineImporter.classList.add('hidden');
            gsheetImporter.classList.add('hidden');
            inputTools.classList.add('hidden');

            if (qaInputMode === 'MANUAL') {
                btnManual.classList.add('bg-white', 'text-corp-600', 'shadow-sm');
                btnManual.classList.remove('text-slate-500');
                
                rawInput.classList.remove('hidden');
                inputTools.classList.remove('hidden');
            } 
            else if (qaInputMode === 'REDMINE') {
                btnRedmine.classList.add('bg-white', 'text-corp-600', 'shadow-sm');
                btnRedmine.classList.remove('text-slate-500');
                
                redmineImporter.classList.remove('hidden');
            }
            else if (qaInputMode === 'GSHEET') {
                btnGSheet.classList.add('bg-white', 'text-corp-600', 'shadow-sm');
                btnGSheet.classList.remove('text-slate-500');
                
                gsheetImporter.classList.remove('hidden');
            }
        }

        // --- CS SPECIFIC LOGIC ---
        function setCsInputMode(mode) {
            csInputMode = mode;
            updateCsInputModeUI();
        }

        function updateCsInputModeUI() {
            const btnManual = document.getElementById('btn-cs-mode-manual');
            const btnLeave = document.getElementById('btn-cs-mode-leave');
            const rawInput = document.getElementById('rawInput');
            const csLeaveImporter = document.getElementById('csLeaveImporter');
            const inputTools = document.getElementById('inputTools');

            if (csInputMode === 'MANUAL') {
                btnManual.classList.add('bg-white', 'text-corp-600', 'shadow-sm');
                btnManual.classList.remove('text-slate-500');
                btnLeave.classList.remove('bg-white', 'text-corp-600', 'shadow-sm');
                btnLeave.classList.add('text-slate-500');
                
                rawInput.classList.remove('hidden');
                csLeaveImporter.classList.add('hidden');
                inputTools.classList.remove('hidden');
            } else {
                btnLeave.classList.add('bg-white', 'text-corp-600', 'shadow-sm');
                btnLeave.classList.remove('text-slate-500');
                btnManual.classList.remove('bg-white', 'text-corp-600', 'shadow-sm');
                btnManual.classList.add('text-slate-500');
                
                rawInput.classList.add('hidden');
                csLeaveImporter.classList.remove('hidden');
                inputTools.classList.add('hidden');
                
                renderCsLeaveList();
            }
        }

        function addCsLeave() {
            const name = document.getElementById('csLeaveName').value.trim();
            const reason = document.getElementById('csLeaveReason').value.trim();
            const hoursVal = document.getElementById('csLeaveHours').value;
            
            if(!name || !reason || !hoursVal) return showToast('請填寫完整資訊');
            
            const hours = parseFloat(hoursVal).toFixed(1);
            
            const newLeave = {
                id: Date.now().toString(), // Simple unique ID
                group: 'CS',
                name: name,
                reason: reason,
                hours: hours
            };
            
            // Add to structured array
            if (!currentDailyData.leaves) currentDailyData.leaves = [];
            currentDailyData.leaves.push(newLeave);
            
            // Reset inputs
            document.getElementById('csLeaveName').value = '';
            document.getElementById('csLeaveReason').value = '';
            document.getElementById('csLeaveHours').value = '';
            
            // UI Update
            renderCsLeaveList();
            parseData(false); // Update dashboards
            saveCurrentReport();
            
            // Keep focus for next entry
            document.getElementById('csLeaveName').focus();
        }

        function deleteCsLeave(id) {
            if(!currentDailyData.leaves) return;
            currentDailyData.leaves = currentDailyData.leaves.filter(item => item.id !== id);
            renderCsLeaveList();
            parseData(false);
            saveCurrentReport();
        }

        function renderCsLeaveList() {
            const container = document.getElementById('csLeaveListDisplay');
            container.innerHTML = '';
            
            const csLeaves = (currentDailyData.leaves || []).filter(l => l.group === 'CS');
            
            if (csLeaves.length === 0) {
                container.innerHTML = `<div class="text-xs text-slate-400 text-center py-4 italic">尚未登錄任何請假資料</div>`;
                return;
            }

            csLeaves.forEach(leave => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between bg-white border border-slate-200 rounded-lg p-2';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="font-bold text-slate-700 text-xs">${leave.name}</div>
                        <div class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${leave.reason}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-mono text-xs font-bold text-orange-500">${leave.hours}h</div>
                        <button onclick="deleteCsLeave('${leave.id}')" class="text-slate-400 hover:text-rose-500 transition px-1">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- GOOGLE SHEET FETCH LOGIC ---
        async function fetchGoogleSheetData() {
            const sheetId = document.getElementById('gsheetId').value.trim();
            const date = document.getElementById('reportDatePicker').value;
            const btn = document.getElementById('btnFetchGSheet');
            const statusMsg = document.getElementById('gsheetStatusMsg');
            
            statusMsg.className = 'hidden mt-1 p-2 rounded text-xs';
            statusMsg.innerHTML = '';

            if (!sheetId) return showToast('請輸入 Google Sheet ID');
            if (!date) return showToast('請先選擇上方的「日報日期」');

            // Column Indexes from UI (safe parsing)
            // Default 0 1 2 3 3 4 5
            const idx = {
                date: parseInt(document.getElementById('colDate').value) || 0,
                name: parseInt(document.getElementById('colName').value) || 1,
                proj: parseInt(document.getElementById('colProj').value) || 2,
                id:   parseInt(document.getElementById('colId').value) || 3,
                cat:  parseInt(document.getElementById('colCat').value) || 3,
                cont: parseInt(document.getElementById('colContent').value) || 4,
                hrs:  parseInt(document.getElementById('colHours').value) || 5
            };

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 讀取中...';
            btn.disabled = true;

            const updateStatus = (msg, type) => {
                statusMsg.classList.remove('hidden', 'bg-rose-50', 'text-rose-700', 'bg-emerald-50', 'text-emerald-700');
                if (type === 'error') statusMsg.classList.add('bg-rose-50', 'text-rose-700');
                else statusMsg.classList.add('bg-emerald-50', 'text-emerald-700');
                statusMsg.innerHTML = msg;
            };

            // Using Google Visualization API query to get JSON
            // Also wrapping in CORS proxy to ensure access from any host
            const gvizUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
            const strategies = [
                { url: gvizUrl, name: 'Direct' },
                { url: `https://corsproxy.io/?${encodeURIComponent(gvizUrl)}`, name: 'CorsProxy' },
                { url: `https://api.allorigins.win/get?url=${encodeURIComponent(gvizUrl)}`, name: 'AllOrigins', wrapper: true }
            ];

            let successJson = null;

            for (const strat of strategies) {
                try {
                    const res = await fetch(strat.url);
                    if (!res.ok) throw new Error('Network Error');
                    let text = await res.text();
                    
                    if (strat.wrapper) {
                        const data = JSON.parse(text);
                        text = data.contents;
                    }

                    // Remove wrapping: "/*O_o*/ google.visualization.Query.setResponse({ ... });"
                    const start = text.indexOf('{');
                    const end = text.lastIndexOf('}') + 1;
                    if (start > -1 && end > -1) {
                        successJson = JSON.parse(text.substring(start, end));
                        break; 
                    }
                } catch(e) {
                    console.warn(`GSheet Strat ${strat.name} failed`, e);
                }
            }

            if (!successJson || !successJson.table) {
                btn.innerHTML = '<i class="fa-brands fa-google mr-1"></i> 匯入資料';
                btn.disabled = false;
                updateStatus('<strong>讀取失敗</strong><br>無法讀取試算表。請確認 ID 正確且權限已設為「知道連結者皆可檢視」。', 'error');
                return;
            }

            // Process Data
            const rows = successJson.table.rows;
            const userMap = {};
            let count = 0;

            rows.forEach(row => {
                const c = row.c;
                if (!c) return;

                // Helper to get value
                const getVal = (i) => (c[i] ? (c[i].f || c[i].v) : '');
                
                // Check Date
                let rowDate = getVal(idx.date);
                if (!rowDate || !String(rowDate).includes(date)) return;

                const name = getVal(idx.name);
                if (!name) return;

                if (!userMap[name]) userMap[name] = { hours: 0, tasks: [] };

                // Get values based on index
                let proj = getVal(idx.proj) || '其他';
                // Remove content inside 【】 brackets completely
                proj = String(proj).replace(/【.*?】/g, '').trim();

                // Get Raw Strings for ID and Cat
                const rawIdStr = getVal(idx.id) || ''; 
                const rawCatStr = getVal(idx.cat) || ''; // Usually same col as ID per user request

                // 1. Process ID: Extract # and numbers only
                let id = 'N/A';
                const idMatch = String(rawIdStr).match(/#\d+/);
                if (idMatch) {
                    id = idMatch[0]; // e.g., "#221233"
                } else {
                    id = ''; // Empty if no #ID found
                }

                // 2. Process Category: Extract text after ID
                let cat = '';
                if (idx.id === idx.cat && id) {
                     // If pulling from same column and ID was found
                     const parts = String(rawCatStr).split(id);
                     if (parts.length > 1) {
                         // Take the part after ID
                         cat = parts.slice(1).join(id).trim(); 
                         // Remove leading :
                         if (cat.startsWith(':') || cat.startsWith('：')) {
                             cat = cat.substring(1).trim();
                         }
                     } else {
                         cat = rawCatStr; 
                     }
                } else {
                     cat = rawCatStr;
                }
                
                const cont = getVal(idx.cont) || '';
                const hrsStr = getVal(idx.hrs);
                const hrs = parseFloat(hrsStr) || 0;

                userMap[name].hours += hrs;
                
                // --- NEW STRUCTURED FORMAT ---
                const lineStr = `[GS]__${proj}__${id}__${cat}__${cont}__${hrs}__編輯 刪除 動作`;
                
                userMap[name].tasks.push(lineStr);
                count++;
            });

            if (count === 0) {
                 updateStatus(`<strong>無資料</strong><br>日期 ${date} 沒有符合的資料。<br>(請確認試算表 A欄為日期格式)`, 'error');
            } else {
                 // Convert to String
                 let finalOutput = "";
                 Object.keys(userMap).forEach(userName => {
                    const user = userMap[userName];
                    const header = `OLD_TS品檢${userName} 小時: ${user.hours.toFixed(2)} 全部摺疊/全部展開`;
                    const body = user.tasks.join(' ');
                    finalOutput += `${header}${body} `;
                 });

                 // Update UI
                 currentDailyData['QA'] = finalOutput;
                 document.getElementById('rawInput').value = finalOutput;
                 
                 // Finish
                 updateStatus(`<strong>匯入成功</strong><br>已讀取 ${count} 筆資料 (模式: Google Sheet)`, 'success');
                 setQaInputMode('MANUAL'); // Switch to view result
                 updateTabUI();
                 parseData(false);
                 saveCurrentReport();
            }

            btn.innerHTML = '<i class="fa-brands fa-google mr-1"></i> 匯入資料';
            btn.disabled = false;
        }

        // --- NEW REDMINE FETCH LOGIC (ISSUES.JSON) - STANDARD HEADER METHOD ONLY ---
        async function fetchRedmineData() {
            const key = document.getElementById('redmineKey').value;
            const projectId = document.getElementById('redmineProjectId').value;
            const date = document.getElementById('reportDatePicker').value;
            const btn = document.getElementById('btnFetchRedmine');
            const statusMsg = document.getElementById('fetchStatusMsg');
            
            statusMsg.className = 'hidden mt-2 p-2 rounded text-xs';
            statusMsg.innerHTML = '';
            
            if (!key || !projectId) return showToast('請輸入 API Key 與 Project ID');
            if (!date) return showToast('請先選擇上方的「日報日期」');

            // Construct Target URL
            const targetUrl = `https://igs.redmine-x.com/time_entries.json?project_id=${projectId}&spent_on=${date}&limit=100`;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 撈取中...';
            btn.disabled = true;

            const updateStatus = (msg, type) => {
                statusMsg.classList.remove('hidden', 'bg-rose-50', 'text-rose-700', 'bg-amber-50', 'text-amber-700', 'bg-emerald-50', 'text-emerald-700');
                if (type === 'error') statusMsg.classList.add('bg-rose-50', 'text-rose-700');
                else if (type === 'warn') statusMsg.classList.add('bg-amber-50', 'text-amber-700');
                else statusMsg.classList.add('bg-emerald-50', 'text-emerald-700');
                statusMsg.innerHTML = msg;
            };

            // AUTO-FALLBACK STRATEGIES
            const strategies = [
                {
                    name: 'Direct (Headers)',
                    url: targetUrl,
                    headers: { "X-Redmine-API-Key": key, "Content-Type": "application/json" },
                    useProxyWrapper: false
                },
                {
                    name: 'CorsProxy',
                    url: `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
                    headers: { "X-Redmine-API-Key": key },
                    useProxyWrapper: false
                },
                {
                    name: 'Direct (Simple)',
                    url: `${targetUrl}&key=${key}`,
                    headers: {},
                    useProxyWrapper: false
                },
                {
                    name: 'AllOrigins',
                    url: `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl + '&key=' + key)}`,
                    headers: {},
                    useProxyWrapper: true
                }
            ];

            let successData = null;
            let lastError = null;

            for (const strategy of strategies) {
                if (strategy.name !== 'Direct (Headers)') updateStatus(`<i class="fa-solid fa-rotate-right fa-spin mr-1"></i> 連線受阻，切換策略 (${strategy.name})...`, 'warn');

                try {
                    const response = await fetch(strategy.url, { method: 'GET', headers: strategy.headers });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    let data = await response.json();
                    
                    if (strategy.useProxyWrapper) {
                        if (data.contents) data = JSON.parse(data.contents);
                        else throw new Error("Invalid Proxy Wrapper");
                    }

                    if (data && data.time_entries) {
                        successData = data;
                        break;
                    }
                } catch (e) {
                    console.warn(`Strategy ${strategy.name} Failed:`, e);
                    lastError = e;
                }
            }

            if (successData) {
                processRedmineData(successData.time_entries); 
                showToast('Redmine 工時資料匯入成功');
                setQaInputMode('MANUAL');
                statusMsg.className = 'hidden'; 
            } else {
                 updateStatus(`<strong>撈取失敗</strong><br>所有連線方式皆失敗。<br>1. 請檢查 API Key<br>2. 請確認 VPN/網路<br><span class="opacity-75">錯誤: ${lastError ? lastError.message : 'Unknown'}</span>`, 'error');
                 showToast('撈取失敗，請查看錯誤訊息');
            }
            
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down mr-1"></i> 撈取工時';
            btn.disabled = false;
        }

        function processRedmineData(entries) {
            if (!entries || entries.length === 0) return showToast('無資料可匯入');

            const userMap = {};
            
            entries.forEach(entry => {
                const userName = entry.user ? entry.user.name : 'Unknown';
                if (!userMap[userName]) {
                    userMap[userName] = { hours: 0, tasks: [] };
                }
                
                const hoursVal = entry.hours ? parseFloat(entry.hours) : 0;
                userMap[userName].hours += hoursVal;
                
                const projectName = entry.project ? entry.project.name : 'Unknown';
                const issueId = entry.issue ? entry.issue.id : 'General';
                const comments = entry.comments || '';
                const activity = entry.activity ? entry.activity.name : '';
                
                // Redmine keeps the original legacy format
                const line = `【${projectName}】 ${activity} #${issueId}: ${comments}｜${hoursVal.toFixed(2)}編輯 刪除 動作`;
                userMap[userName].tasks.push(line);
            });

            let finalOutput = "";
            Object.keys(userMap).forEach(userName => {
                const user = userMap[userName];
                const header = `OLD_TS品檢${userName} ${user.hours.toFixed(2)} 小時: ${user.hours.toFixed(2)} 全部摺疊/全部展開`;
                const body = user.tasks.join(' ');
                finalOutput += `${header}${body} `;
            });

            currentDailyData['QA'] = finalOutput;
            document.getElementById('rawInput').value = finalOutput;
            
            updateTabUI();
            parseData(false);
            saveCurrentReport(); 
        }


        function getGroupName(code) {
            const map = { 
                'ALL': '總覽',
                'TECH': '技術', 
                'QA': '品檢', 
                'CS': '客服', 
                'WEB': '網頁',
                'ART': '美術',
                'DB': '資料庫'
            };
            return map[code] || code;
        }

        // --- NEW PARSING LOGIC MODULES ---
        const GroupParsers = {
            _commonParse: function(rawContent, groupCode, groupNameLabel) {
                const results = [];
                const rawPeople = rawContent.split('OLD_TS').filter(item => item.trim().length > 0);
                
                rawPeople.forEach(personBlock => {
                    const headerMatch = personBlock.match(/^\s*(.+?)[\s\d]+小時:\s*([\d\.]+)/);
                    if (headerMatch) {
                        let originalName = headerMatch[1].trim(); 
                        let name = originalName;
                        
                        // Clean up name prefix if it exists in the raw text
                        ['品檢', '客服', '網頁', '技術', '美術', '資料庫'].forEach(prefix => {
                             if(name.startsWith(prefix)) name = name.substring(prefix.length).trim();
                        });

                        const totalHours = parseFloat(headerMatch[2]);

                        let taskString = personBlock.replace(headerMatch[0], '').replace(/全部摺疊\/全部展開/g, '');
                        const rawTasks = taskString.split(/編輯\s+刪除\s+動作/);
                        const tasks = [];

                        rawTasks.forEach(t => {
                            t = t.trim();
                            if (t.length === 0) return;

                            // ---------------------------------------------------------
                            // MODE 1: Google Sheet Structured Format (Independent Logic)
                            // Format: [GS]__Proj__ID__Cat__Content__Hrs
                            // ---------------------------------------------------------
                            if (t.startsWith('[GS]__')) {
                                const parts = t.replace('[GS]__', '').split('__');
                                // parts: [0]Proj, [1]ID, [2]Cat, [3]Content, [4]Hrs
                                if (parts.length >= 5) {
                                    const pProj = parts[0] || '其他';
                                    const pId = parts[1] || 'N/A';
                                    const pCat = parts[2] || '';
                                    const pCont = parts[3] || '';
                                    const pHrs = parseFloat(parts[4]) || 0;
                                    
                                    tasks.push({ 
                                        project: pProj, 
                                        category: pCat, 
                                        id: pId, 
                                        content: pCont, 
                                        hours: pHrs 
                                    });
                                }
                                return; // Skip legacy logic
                            }


                            // ---------------------------------------------------------
                            // MODE 2: Legacy / Redmine Manual Input (Fuzzy Logic)
                            // ---------------------------------------------------------

                            // --- Ignore Redmine pagination and footer noise ---
                            if (
                                t.includes('Powered by Redmine') || 
                                t.includes('Upgraded by RedmineX') ||
                                t.includes('匯出至') || 
                                (t.includes('每頁顯示') && t.includes('個')) || 
                                t.match(/«\s*上一頁/) || 
                                t.match(/下一頁\s*»/) ||
                                /^\d+$/.test(t) || 
                                /^Atom$/.test(t) ||
                                /^CSV$/.test(t) ||
                                /^XLSX$/.test(t)
                            ) {
                                return;
                            }

                            const idMatch = t.match(/#(\d+)/);
                            const id = idMatch ? idMatch[1] : '';
                            let project = '其他';
                            
                            // Legacy Project Extraction Rule
                            if (t.includes('】') && t.includes('#')) {
                                const match = t.match(/】(.*?)#/);
                                if (match) project = match[1].trim();
                            } else if (t.includes('#')) {
                                project = t.split('#')[0].replace(/【.*?】/g, '').trim();
                            } else if (t.includes('【')) {
                                const match = t.match(/【(.*?)】/);
                                if(match) project = match[1];
                            }
                            project = project.replace(/測試|支援|功能/g, '').trim();
                            
                            const hoursMatch = t.match(/(\d+\.\d+)$/);
                            const taskHours = hoursMatch ? parseFloat(hoursMatch[1]) : 0;
                            let content = t;
                            let category = '';
                            
                            if (idMatch) {
                                const parts = t.split('#' + id);
                                if (parts[1]) {
                                    let rightSide = parts[1];
                                    if (hoursMatch) rightSide = rightSide.substring(0, rightSide.lastIndexOf(hoursMatch[0]));
                                    rightSide = rightSide.trim();
                                    if (rightSide.startsWith(':')) rightSide = rightSide.substring(1).trim();
                                    const contentStartRegex = /(測試項目數|回報問題數|測試內容|問題回報|回報問題)/;
                                    const splitMatch = rightSide.search(contentStartRegex);
                                    if (splitMatch !== -1) {
                                        category = rightSide.substring(0, splitMatch).trim();
                                        content = rightSide.substring(splitMatch).trim();
                                    } else {
                                        category = rightSide; content = '';
                                    }
                                    if (category.endsWith('｜')) category = category.slice(0, -1).trim();
                                }
                            }
                            tasks.push({ project, category, id, content, hours: taskHours });
                        });
                        
                        // Use the provided groupNameLabel
                        results.push({ name, group: groupNameLabel, totalHours, tasks });
                    }
                });
                return results;
            },
            
            TECH: { parse: (txt) => GroupParsers._commonParse(txt, 'TECH', '技術') },
            QA:   { parse: (txt) => GroupParsers._commonParse(txt, 'QA', '品檢') },
            CS:   { parse: (txt) => GroupParsers._commonParse(txt, 'CS', '客服') },
            WEB:  { parse: (txt) => GroupParsers._commonParse(txt, 'WEB', '網頁') },
            ART:  { parse: (txt) => GroupParsers._commonParse(txt, 'ART', '美術') },
            DB:   { parse: (txt) => GroupParsers._commonParse(txt, 'DB', '資料庫') }
        };

        function handleInputUpdate() {
            if (activeTab === 'ALL') return;
            const val = document.getElementById('rawInput').value;
            currentDailyData[activeTab] = val;
            updateTabUI(); // Update status dots
        }

        // --- HISTORY LIST ---
        function updateHistoryList() {
            const db = getDB();
            const dates = Object.keys(db).sort().reverse(); 
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';

            if(dates.length === 0) {
                listEl.innerHTML = '<div class="text-xs text-slate-400 p-2 text-center">尚無紀錄</div>';
                return;
            }

            dates.forEach(date => {
                const item = document.createElement('div');
                item.className = `p-2 rounded cursor-pointer text-sm flex justify-between items-center hover:bg-slate-50 transition ${date === currentReportDate ? 'active-date' : 'text-slate-600'}`;
                item.onclick = () => loadReportByDate(date);
                item.innerHTML = `
                    <span><i class="fa-regular fa-calendar mr-2 opacity-50"></i>${date}</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-30"></i>
                `;
                listEl.appendChild(item);
            });
        }

        // --- MAIN ACTIONS ---
        function loadReportByDate(date) {
            currentReportDate = date;
            document.getElementById('reportDatePicker').value = date;
            updateHistoryList();

            const db = getDB();
            let data = db[date];

            // Migration / Reset Logic
            if (!data) {
                // New Day - Reset all fields
                ALL_GROUPS.forEach(g => currentDailyData[g] = '');
                currentDailyData.leaves = [];
                clearViews();
                switchTab('ALL'); 
            } else {
                // Load data
                if (typeof data === 'string') {
                      // Legacy support
                      ALL_GROUPS.forEach(g => currentDailyData[g] = '');
                      currentDailyData.QA = data; 
                      currentDailyData.leaves = [];
                } else {
                    // Object version
                    ALL_GROUPS.forEach(g => {
                        currentDailyData[g] = data[g] || '';
                    });
                    // Load leaves if exist
                    currentDailyData.leaves = data.leaves || [];
                }
                
                updateTabUI(); // Set dots
                parseData(false);
                switchTab('ALL'); // Default to ALL view on load
            }
        }

        function clearViews() {
            document.getElementById('rawInput').value = '';
            document.getElementById('analysisSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('headerTotalManHours').innerText = "尚未計算";
            updateTabUI();
        }

        function createNewReport() {
            const today = new Date().toISOString().split('T')[0];
            loadReportByDate(today);
            switchTab('ALL');
            showToast(`已切換至今日 (${today})`);
        }

        function handleDateChange() {
            const newDate = document.getElementById('reportDatePicker').value;
            if(newDate) loadReportByDate(newDate);
        }

        function saveCurrentReport() {
            const date = document.getElementById('reportDatePicker').value;
            if(!date) return showToast('請選擇日期');

            const db = getDB();
            db[date] = currentDailyData; 
            saveDB(db);
            
            showToast('資料已儲存');
            updateTabUI();
            
            // Re-parse to ensure view is consistent
            parseData(false);
        }

        // --- EXPORT / IMPORT / CLEAR ACTIONS (IMPLEMENTED) ---
        function exportData() {
            const db = getDB();
            if (Object.keys(db).length === 0) return showToast('目前無任何資料可備份');
            
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily_report_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('備份檔案下載中');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Basic validation
                    if (typeof data !== 'object') throw new Error('Invalid JSON');
                    
                    saveDB(data);
                    
                    // Reload current date to reflect changes
                    loadReportByDate(currentReportDate);
                    showToast('資料還原成功');
                } catch (error) {
                    console.error(error);
                    showToast('檔案格式錯誤，無法匯入');
                }
                // Reset input
                input.value = '';
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('警告：確定要清空所有歷史紀錄嗎？此動作無法復原。')) {
                localStorage.removeItem(DB_KEY);
                // Reset current view
                const today = new Date().toISOString().split('T')[0];
                loadReportByDate(today);
                showToast('所有資料已清空');
            }
        }

        // --- PARSING LOGIC ---
        function loadDemo() {
            const demoText = `專案議題回應小時  OLD_TS品檢呂孟軒 4 小時: 8.00 全部摺疊/全部展開【品檢組】網頁組測試 #221233: [智能行銷]20251211版更品檢測試測試項目數：11｜問題回報：7｜測試內容：開案、展表、介面功能驗證、與窗口討論測試內容、確認規格｜3.50編輯 刪除 動作 支援測試 #999999: [會員系統]壓力測試｜4.50編輯 刪除 動作`;
            
            if (activeTab === 'ALL') {
                alert("請先切換至特定組別 (如：品檢、技術) 再載入範例");
                return;
            }
            
            currentDailyData[activeTab] = demoText;
            document.getElementById('rawInput').value = demoText;
            updateTabUI();
            
            // Auto parse and save for convenience
            parseData();
            showToast('範例資料已載入');
        }

        function parseData(scroll = true) {
            parsedData = [];
            let totalTeamHours = 0;
            let hasAnyData = false;
            
            // Filtering Logic: 
            // If ALL, process all groups. 
            // If specific tab, only process that group.
            const groupsToProcess = activeTab === 'ALL' ? ALL_GROUPS : [activeTab];

            // Iterate through selected groups
            groupsToProcess.forEach(groupCode => {
                const rawContent = currentDailyData[groupCode];
                if(!rawContent || !rawContent.trim()) return;

                hasAnyData = true;
                
                // DELEGATE PARSING TO MODULE
                const groupParser = GroupParsers[groupCode];
                if (!groupParser) {
                    console.error("No parser found for", groupCode);
                    return;
                }

                const groupResult = groupParser.parse(rawContent);
                
                if (groupResult && groupResult.length > 0) {
                      parsedData = parsedData.concat(groupResult);
                      // Accumulate hours for total stat
                      groupResult.forEach(p => totalTeamHours += p.totalHours);
                }
            });

            // Even if we are in a tab with no data, we should render empty view
            if (!hasAnyData && (!currentDailyData.leaves || currentDailyData.leaves.length === 0)) {
                // If it's a specific tab, we might want to clear views, but also we are editing, 
                // so we don't want to hide everything. Just hide results.
                document.getElementById('analysisSection').classList.add('hidden');
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('headerTotalManHours').innerText = "0 人 / 0.0hr";
                
                // If ALL tab and no data anywhere, verify missing info
                if (activeTab === 'ALL') updateMissingInfoText(); 
                return;
            }

            if (parsedData.length === 0 && (!currentDailyData.leaves || currentDailyData.leaves.length === 0)) {
                if (activeTab === 'ALL') updateMissingInfoText();
                return;
            }

            const statsText = `${parsedData.length}人 / ${totalTeamHours.toFixed(1)}hr`;
            document.getElementById('headerTotalManHours').innerText = statsText;
            document.getElementById('widgetTotalManHours').innerText = statsText;
            
            renderDashboard();
            renderDetailView();
            
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            if(scroll && activeTab !== 'ALL') {
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }
            
            if (activeTab === 'ALL') updateMissingInfoText();
        }

        // --- RENDERERS ---
        function renderDashboard() {
            const tbody = document.getElementById('hoursTableBody');
            tbody.innerHTML = '';
            const sortedData = [...parsedData].sort((a,b) => b.totalHours - a.totalHours);

            let rows = '';
            sortedData.forEach(p => {
                let barColor = 'bg-emerald-500';
                let hoursClass = 'text-emerald-700';
                if (p.totalHours < 8) { barColor = 'bg-amber-400'; hoursClass = 'text-amber-700'; }
                else if (p.totalHours > 10) { barColor = 'bg-rose-500'; hoursClass = 'text-rose-700'; }
                let width = Math.min((p.totalHours / 12) * 100, 100);

                rows += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-2 font-medium text-slate-700 text-xs">${p.name}</td>
                        <td class="p-2 align-middle">
                            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                <div class="${barColor} h-2 rounded-full" style="width: ${width}%"></div>
                            </div>
                        </td>
                        <td class="p-2 text-right font-bold font-mono text-xs ${hoursClass}">${p.totalHours.toFixed(1)}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = rows;

            const leaveContainer = document.getElementById('leaveListContainer');
            let leaveHtml = `<ul class="space-y-3">`;
            let hasLeave = false;

            // 1. Render leaves from parsed text data (Legacy/Standard)
            parsedData.forEach(p => {
                p.tasks.forEach(t => {
                    if (t.category.includes('請假') || t.content.includes('請假') || t.category.includes('特休') || t.category.includes('事假') || t.category.includes('病假')) {
                        hasLeave = true;
                        leaveHtml += `
                            <li class="flex items-start bg-rose-50 border border-rose-100 p-2 rounded-lg">
                                <div class="bg-rose-200 text-rose-700 rounded-full w-6 h-6 flex items-center justify-center shrink-0 mr-2 font-bold text-[10px]">${p.name[0]}</div>
                                <div>
                                    <div class="font-bold text-slate-800 text-xs">${p.name}</div>
                                    <div class="text-xs text-rose-600 font-medium mt-0.5">${t.category.replace('請假', '')}</div>
                                    <div class="text-[10px] text-slate-500 font-mono inline-block">${t.hours} hr</div>
                                </div>
                            </li>
                        `;
                    }
                });
            });

            // 2. Render leaves from structured data (New CS feature)
            if (currentDailyData.leaves && currentDailyData.leaves.length > 0) {
                currentDailyData.leaves.forEach(l => {
                    hasLeave = true;
                    leaveHtml += `
                        <li class="flex items-start bg-rose-50 border border-rose-100 p-2 rounded-lg">
                            <div class="bg-rose-200 text-rose-700 rounded-full w-6 h-6 flex items-center justify-center shrink-0 mr-2 font-bold text-[10px]">${l.name[0]}</div>
                            <div>
                                <div class="font-bold text-slate-800 text-xs">${l.name} <span class="text-[10px] text-slate-400 font-normal ml-1">(${getGroupName(l.group)})</span></div>
                                <div class="text-xs text-rose-600 font-medium mt-0.5">${l.reason}</div>
                                <div class="text-[10px] text-slate-500 font-mono inline-block">${l.hours} hr</div>
                            </div>
                        </li>
                    `;
                });
            }

            leaveHtml += `</ul>`;
            leaveContainer.innerHTML = hasLeave ? leaveHtml : `<div class="flex flex-col items-center justify-center h-full text-slate-400 py-4"><i class="fa-regular fa-calendar-check text-2xl mb-1 text-emerald-100"></i><p class="text-xs">全員出勤</p></div>`;
        }

        function formatContentForWeb(text) {
            if (!text) return '';
            const segments = text.split(/[｜|]/);
            return segments.map(seg => {
                seg = seg.trim();
                if (!seg) return '';
                if (seg.includes('項目數') || seg.includes('回報問題數')) {
                    const num = seg.match(/\d+/);
                    const n = num ? parseInt(num[0]) : 0;
                    const colorClass = n > 0 ? 'bg-red-50 text-red-600 ring-1 ring-red-200' : 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium ${colorClass} mr-2 mb-1">${seg}</span>`;
                }
                if (seg.includes('測試內容') || seg.includes('工作事項')) {
                     return `<div class="mt-1 block text-slate-600 text-xs"><span class="font-bold text-slate-700">${seg.split('：')[0]}：</span>${seg.split('：')[1] || ''}</div>`;
                }
                return `<span class="mr-2 text-slate-700">${seg}</span>`;
            }).join('');
        }

        function toggleTask(btn) {
            const container = btn.parentElement;
            const content = container.querySelector('.accordion-content');
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            
            btn.setAttribute('aria-expanded', !isExpanded);
            if (!isExpanded) {
                content.classList.add('expanded');
                content.classList.add('p-3');
                content.classList.add('pt-0');
            } else {
                content.classList.remove('expanded');
                content.classList.remove('p-3');
                content.classList.remove('pt-0');
            }
        }

        function renderDetailView() {
            const container = document.getElementById('detailView');
            container.innerHTML = '';
            parsedData.forEach((p, pIndex) => {
                let hoursColor = 'bg-emerald-100 text-emerald-800';
                if (p.totalHours < 8) hoursColor = 'bg-amber-100 text-amber-800';
                if (p.totalHours > 10) hoursColor = 'bg-rose-100 text-rose-800';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col md:flex-row overflow-hidden mb-2';
                
                // Add Group to Name Display - Compact One-Line Version
                const displayName = p.group ? `<span class="text-xs text-slate-500 mr-1">[${p.group}]</span>${p.name}` : p.name;
                
                let tasksHtml = p.tasks.map((t, tIndex) => `
                    <div class="border-b border-slate-100 last:border-0">
                        <button class="accordion-btn w-full text-left p-2 flex items-center justify-between hover:bg-slate-50 transition group focus:outline-none" onclick="toggleTask(this)" aria-expanded="false">
                            <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1 pr-4">
                                <span class="text-xs font-bold text-slate-800">${t.project}</span>
                                <span class="text-[10px] font-mono text-slate-400">#${t.id}</span>
                                <span class="text-xs text-slate-600">${t.category}</span>
                                <span class="text-xs font-bold text-corp-600 font-mono">: ${t.hours}hr</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-xs accordion-icon group-hover:text-corp-600"></i>
                        </button>
                        <div class="accordion-content bg-slate-50/50">
                            <div class="text-xs leading-relaxed pl-1 pt-2 border-t border-slate-100 border-dashed mx-3 mb-0">
                                ${formatContentForWeb(t.content)}
                            </div>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-2 md:w-auto md:min-w-[6rem] bg-slate-50 md:border-r border-b md:border-b-0 border-slate-200 flex flex-row md:flex-col items-center justify-between md:justify-center gap-1 shrink-0">
                        <div class="font-bold text-sm text-slate-800 text-center leading-tight whitespace-nowrap">
                            ${displayName}
                        </div>
                        <div class="px-2 py-0.5 rounded-full text-[10px] font-bold ${hoursColor}">${p.totalHours.toFixed(1)}h</div>
                    </div>
                    <div class="flex-1 bg-white flex flex-col">${tasksHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
