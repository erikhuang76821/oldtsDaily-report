<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團隊日報管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { 50: '#f0f9ff', 100: '#e0f2fe', 600: '#0284c7', 800: '#075985' }
                    }
                }
            }
        }
    </script>
    <!-- Added type="text/tailwindcss" to ensure @apply works correctly -->
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .active-date { background-color: #e0f2fe; border-right: 4px solid #0284c7; color: #075985; font-weight: bold; }
        
        /* Button Styles */
        .header-tab-btn { 
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all duration-200 flex items-center gap-2 text-slate-500 whitespace-nowrap relative border border-transparent; 
        }
        
        /* State: Hover */
        .header-tab-btn:hover:not(.active) {
            @apply bg-slate-100 text-slate-700;
        }

        /* State: Active (Selected) - High Contrast */
        .header-tab-btn.active { 
            @apply bg-corp-600 text-white shadow-md; 
        }
        
        /* State: Has Data (Uploaded) */
        .header-tab-btn.has-data .data-dot { @apply scale-100; }
        .header-tab-btn.no-data .data-dot { @apply scale-0; }

        /* Data Dot Color - White on Active, Green on Inactive */
        .header-tab-btn.active .data-dot { @apply bg-white; }
        .header-tab-btn:not(.active) .data-dot { @apply bg-emerald-500; }

        .data-dot {
            @apply w-2 h-2 rounded-full transition-transform duration-300;
        }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.expanded {
            max-height: 1000px; 
            opacity: 1;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-btn[aria-expanded="true"] .accordion-icon {
            transform: rotate(180deg);
        }

    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-800 flex">

    <!-- Sidebar: History & Tools -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col h-full shrink-0 shadow-lg z-20 hidden md:flex">
        <div class="p-4 border-b border-slate-100">
            <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-corp-600"></i> 日報管理系統
            </h1>
            <p class="text-xs text-slate-400 mt-1">GitHub Page 版本</p>
        </div>
        
        <div class="p-3">
            <button onclick="createNewReport()" class="w-full bg-corp-600 hover:bg-corp-800 text-white py-2 px-4 rounded-lg shadow text-sm font-bold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> 新增今日日報
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll px-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2 mt-2">歷史紀錄</h3>
            <div id="historyList" class="space-y-1">
                <!-- JS Populated -->
            </div>
        </div>

        <div class="p-4 border-t border-slate-200 bg-slate-50">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">資料管理</h3>
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition" title="匯出 JSON">
                    <i class="fa-solid fa-download"></i> 備份
                </button>
                <label class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition text-center cursor-pointer" title="匯入 JSON">
                    <i class="fa-solid fa-upload"></i> 還原
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </label>
            </div>
            <button onclick="clearAllData()" class="w-full mt-2 text-rose-500 hover:text-rose-700 text-xs text-center underline">
                清空所有資料
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- Toolbar Header -->
        <header class="bg-white border-b border-slate-200 p-3 md:p-4 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm z-10 shrink-0 gap-4 md:gap-0">
            <div class="flex items-center gap-4 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 custom-scroll">
                <!-- Mobile Menu Toggle -->
                <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="md:hidden text-slate-500 hover:text-slate-800">
                    <i class="fa-solid fa-bars"></i>
                </button>

                <!-- Date Picker -->
                <div class="flex flex-col mr-2 shrink-0">
                    <label class="text-[10px] text-slate-400 font-bold uppercase leading-none mb-1">日報日期</label>
                    <input type="date" id="reportDatePicker" class="font-bold text-base text-slate-800 bg-transparent border-none p-0 focus:ring-0 cursor-pointer h-6 w-32" onchange="handleDateChange()">
                </div>

                <div class="hidden md:block h-8 w-px bg-slate-200 mx-2 shrink-0"></div>

                <!-- Tabs (Inline classes to ensure Flex layout works correctly) -->
                <div class="flex items-center bg-white rounded-lg border border-slate-200 p-1 shadow-sm" id="tabContainer">
                    <button onclick="switchTab('ALL')" id="tab-ALL" class="header-tab-btn active">
                        <i class="fa-solid fa-chart-pie"></i> 總覽
                    </button>
                    
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>
                    
                    <button onclick="switchTab('TECH')" id="tab-TECH" class="header-tab-btn">
                        <span class="data-dot"></span> 技術
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('QA')" id="tab-QA" class="header-tab-btn">
                        <span class="data-dot"></span> 品檢
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('CS')" id="tab-CS" class="header-tab-btn">
                        <span class="data-dot"></span> 客服
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('WEB')" id="tab-WEB" class="header-tab-btn">
                        <span class="data-dot"></span> 網頁
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('ART')" id="tab-ART" class="header-tab-btn">
                        <span class="data-dot"></span> 網頁美術
                    </button>
                    <div class="w-px h-4 bg-slate-200 mx-1 shrink-0"></div>

                    <button onclick="switchTab('DB')" id="tab-DB" class="header-tab-btn">
                        <span class="data-dot"></span> 資料庫
                    </button>
                </div>
            </div>

            <!-- Right Actions (Simplified) -->
            <div class="flex items-center gap-3 w-full md:w-auto justify-end mt-2 md:mt-0 shrink-0">
                <div id="headerTotalManHours" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full font-bold whitespace-nowrap">
                    尚未計算
                </div>
                <button onclick="saveCurrentReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> <span class="hidden md:inline">儲存</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 bg-slate-50">
            
            <!-- Missing Info Alert (Only visible in ALL tab) -->
            <div id="missingDataInfo" class="hidden bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-3 shadow-sm">
                <div id="missingIconContainer" class="bg-blue-100 text-blue-600 p-2 rounded-full shrink-0">
                    <i id="missingIcon" class="fa-solid fa-circle-info text-lg"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-blue-800 text-sm mb-1">日報資料狀態提示</h4>
                    <p class="text-sm text-blue-600" id="missingDataText">目前所有組別皆已匯入資料。</p>
                </div>
            </div>

            <!-- Editor / Input (Hidden in ALL tab) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-0 transition-all duration-300 overflow-hidden" id="inputSectionCard">
                <!-- Header -->
                <div class="bg-slate-50 border-b border-slate-200 px-4 md:px-6 py-3 flex justify-between items-center">
                    <label class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                        <i class="fa-regular fa-keyboard text-slate-400"></i> 
                        <span id="inputLabelGroup">原始資料輸入</span> 
                        <span class="text-xs font-mono text-slate-400 bg-slate-100 px-1 rounded">OLD_TS</span>
                    </label>
                    
                    <!-- Tools -->
                    <div class="flex gap-2" id="inputTools">
                        <button onclick="parseData()" class="text-xs bg-corp-600 hover:bg-corp-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm">
                            <i class="fa-solid fa-rotate mr-1"></i> 解析資料
                        </button>
                        <button id="btnLoadDemo" onclick="loadDemo()" class="text-xs text-slate-400 hover:text-corp-600 hover:bg-slate-100 px-2 py-1 rounded transition">
                            載入範例
                        </button>
                    </div>
                </div>

                <!-- Input Area -->
                <div id="inputAreaContainer" class="p-0">
                    <textarea id="rawInput" class="w-full h-48 p-4 border-none focus:ring-0 font-mono text-sm bg-white resize-y placeholder-slate-300 outline-none" placeholder="在此貼上日報內容..." oninput="handleInputUpdate()"></textarea>
                </div>
            </section>

            <!-- Detail List & Export (Removed Copy Buttons) -->
            <section id="resultSection" class="hidden space-y-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b border-slate-200 pb-2 gap-2">
                    <h3 class="font-bold text-slate-700 text-lg">
                        <i class="fa-solid fa-list-check text-slate-400 mr-2"></i> 彙整結果 <span id="resultSectionTitleSuffix" class="text-sm text-slate-400 ml-2 font-normal"></span>
                    </h3>
                </div>
                <div id="detailView" class="space-y-4"></div>
            </section>

            <!-- Dashboard Widgets (Moved Down) -->
            <div id="analysisSection" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Work Hours Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-2">
                            <i class="fa-solid fa-clock"></i>
                        </span>
                        工時統計
                        <span id="widgetTotalManHours" class="ml-auto text-xs bg-slate-100 px-2 py-1 rounded-full font-normal text-slate-500"></span>
                    </h3>
                    <div class="overflow-y-auto custom-scroll max-h-[250px]">
                        <table class="w-full text-sm">
                            <tbody id="hoursTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Leave Details -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                        <span class="w-8 h-8 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center mr-2">
                            <i class="fa-solid fa-clipboard-user"></i>
                        </span>
                        請假 / 未出勤明細
                    </h3>
                    <div id="leaveListContainer" class="flex-1 overflow-y-auto custom-scroll max-h-[250px]"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // --- STORAGE & STATE MANAGER ---
        const DB_KEY = 'daily_reports_db_v4_expanded'; 
        let currentReportDate = '';
        
        // Data Model Definitions
        const ALL_GROUPS = ['TECH', 'QA', 'CS', 'WEB', 'ART', 'DB'];
        
        let currentDailyData = {
            TECH: '',
            QA: '',
            CS: '',
            WEB: '',
            ART: '',
            DB: ''
        };
        let activeTab = 'ALL'; // Default to ALL
        let parsedData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            updateHistoryList();
            loadReportByDate(today);
        });

        function getDB() {
            const data = localStorage.getItem(DB_KEY);
            return data ? JSON.parse(data) : {};
        }

        function saveDB(data) {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            updateHistoryList();
        }

        // --- TAB LOGIC ---
        function updateTabUI() {
            // Check status of each group and update UI colors
            ALL_GROUPS.forEach(group => {
                const btn = document.getElementById(`tab-${group}`);
                const hasData = currentDailyData[group] && currentDailyData[group].trim().length > 0;
                
                if (hasData) {
                    btn.classList.add('has-data');
                    btn.classList.remove('no-data');
                } else {
                    btn.classList.add('no-data');
                    btn.classList.remove('has-data');
                }
            });
            updateMissingInfoText();
        }

        function updateMissingInfoText() {
            const missing = [];
            
            // Check all groups defined
            ALL_GROUPS.forEach(group => {
                if (!currentDailyData[group] || !currentDailyData[group].trim()) {
                    missing.push(getGroupName(group));
                }
            });

            const infoText = document.getElementById('missingDataText');
            const infoBox = document.getElementById('missingDataInfo');
            const iconContainer = document.getElementById('missingIconContainer');
            const icon = document.getElementById('missingIcon');
            
            if (missing.length === ALL_GROUPS.length) {
                infoText.innerHTML = '尚無任何資料，請切換至各組別標籤進行輸入。';
                infoBox.className = "bg-slate-100 border border-slate-200 rounded-xl p-4 flex items-start gap-3 shadow-sm";
                icon.className = "fa-solid fa-circle-info text-lg text-slate-400";
                iconContainer.className = "bg-slate-200 text-slate-500 p-2 rounded-full shrink-0";
            } else if (missing.length > 0) {
                // Determine display logic for missing list - if too many, summarize
                let missingHtml = '';
                if(missing.length > 3) {
                   missingHtml = `<span class="font-bold text-rose-600">${missing.length} 個組別</span>`;
                } else {
                   missingHtml = `<span class="font-bold text-rose-600">${missing.join('、')}</span>`;
                }

                infoText.innerHTML = `以下組別尚未匯入資料：${missingHtml}`;
                infoBox.className = "bg-amber-50 border border-amber-100 rounded-xl p-4 flex items-start gap-3 shadow-sm";
                icon.className = "fa-solid fa-triangle-exclamation text-lg text-amber-500";
                iconContainer.className = "bg-amber-100 text-amber-600 p-2 rounded-full shrink-0";
            } else {
                infoText.innerHTML = '<span class="text-emerald-600 font-bold"><i class="fa-solid fa-check mr-1"></i> 所有組別皆已完成資料匯入。</span>';
                infoBox.className = "bg-emerald-50 border border-emerald-100 rounded-xl p-4 flex items-start gap-3 shadow-sm";
                icon.className = "fa-solid fa-check-circle text-lg text-emerald-500";
                iconContainer.className = "bg-emerald-100 text-emerald-600 p-2 rounded-full shrink-0";
            }
        }

        function switchTab(tab) {
            activeTab = tab;

            // Update Header Tab Styles
            document.querySelectorAll('.header-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Elements
            const inputCard = document.getElementById('inputSectionCard');
            const missingInfo = document.getElementById('missingDataInfo');
            const textarea = document.getElementById('rawInput');
            const labelGroup = document.getElementById('inputLabelGroup');
            const titleSuffix = document.getElementById('resultSectionTitleSuffix');

            if (tab === 'ALL') {
                // Overview Mode
                inputCard.classList.add('hidden'); // Hide Input
                missingInfo.classList.remove('hidden'); // Show Info
                titleSuffix.innerText = "(全部總覽)";
                
                // Force a re-parse to ensure dashboard is up to date based on ALL data
                parseData(false);

            } else {
                // Group Input Mode
                inputCard.classList.remove('hidden'); // Show Input
                missingInfo.classList.add('hidden'); // Hide Info
                titleSuffix.innerText = `(${getGroupName(tab)})`;
                
                // Set Label & Textarea
                labelGroup.innerText = `${getGroupName(tab)} - 原始資料輸入`;
                textarea.value = currentDailyData[tab] || '';
                textarea.placeholder = `在此貼上【${getGroupName(tab)}】的 OLD_TS 原始資料...`;
                
                // Trigger parseData again to filter the view ONLY for this tab
                parseData(false);
                
                // Focus slightly delayed to allow UI update
                setTimeout(() => textarea.focus(), 50);
            }
        }

        function getGroupName(code) {
            const map = { 
                'ALL': '總覽',
                'TECH': '技術', 
                'QA': '品檢', 
                'CS': '客服', 
                'WEB': '網頁',
                'ART': '網頁美術',
                'DB': '資料庫'
            };
            return map[code] || code;
        }

        function handleInputUpdate() {
            if (activeTab === 'ALL') return;
            const val = document.getElementById('rawInput').value;
            currentDailyData[activeTab] = val;
            updateTabUI(); // Update status dots
        }

        // --- HISTORY LIST ---
        function updateHistoryList() {
            const db = getDB();
            const dates = Object.keys(db).sort().reverse(); 
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';

            if(dates.length === 0) {
                listEl.innerHTML = '<div class="text-xs text-slate-400 p-2 text-center">尚無紀錄</div>';
                return;
            }

            dates.forEach(date => {
                const item = document.createElement('div');
                item.className = `p-2 rounded cursor-pointer text-sm flex justify-between items-center hover:bg-slate-50 transition ${date === currentReportDate ? 'active-date' : 'text-slate-600'}`;
                item.onclick = () => loadReportByDate(date);
                item.innerHTML = `
                    <span><i class="fa-regular fa-calendar mr-2 opacity-50"></i>${date}</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-30"></i>
                `;
                listEl.appendChild(item);
            });
        }

        // --- MAIN ACTIONS ---
        function loadReportByDate(date) {
            currentReportDate = date;
            document.getElementById('reportDatePicker').value = date;
            updateHistoryList();

            const db = getDB();
            let data = db[date];

            // Migration / Reset Logic
            if (!data) {
                // New Day - Reset all fields
                ALL_GROUPS.forEach(g => currentDailyData[g] = '');
                clearViews();
                switchTab('ALL'); 
            } else {
                // Compatibility check & Migration
                if (typeof data === 'string') {
                    // Very old string version
                     ALL_GROUPS.forEach(g => currentDailyData[g] = '');
                     currentDailyData.QA = data; // Assume old was QA
                } else {
                    // Object version - merge to ensure new keys exist
                    ALL_GROUPS.forEach(g => {
                        currentDailyData[g] = data[g] || '';
                    });
                }
                
                updateTabUI(); // Set dots
                parseData(false);
                switchTab('ALL'); // Default to ALL view on load
            }
        }

        function clearViews() {
            document.getElementById('rawInput').value = '';
            document.getElementById('analysisSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('headerTotalManHours').innerText = "尚未計算";
            updateTabUI();
        }

        function createNewReport() {
            const today = new Date().toISOString().split('T')[0];
            loadReportByDate(today);
            switchTab('ALL');
        }

        function handleDateChange() {
            const newDate = document.getElementById('reportDatePicker').value;
            if(newDate) loadReportByDate(newDate);
        }

        function saveCurrentReport() {
            const date = document.getElementById('reportDatePicker').value;
            if(!date) return showToast('請選擇日期');

            const db = getDB();
            db[date] = currentDailyData; 
            saveDB(db);
            
            showToast('資料已儲存');
            updateTabUI();
            
            // Re-parse to ensure view is consistent
            parseData(false);
        }

        function deleteCurrentReport() {
            if(!confirm('確定要刪除這天的日報嗎？無法復原。')) return;
            const db = getDB();
            delete db[currentReportDate];
            saveDB(db);
            loadReportByDate(new Date().toISOString().split('T')[0]);
            showToast('已刪除');
        }

        // --- PARSING LOGIC ---
        function loadDemo() {
            const demoText = `專案議題回應小時  OLD_TS品檢呂孟軒 4 小時: 8.00 全部摺疊/全部展開【品檢組】網頁組測試 #221233: [智能行銷]20251211版更品檢測試測試項目數：11｜問題回報：7｜測試內容：開案、展表、介面功能驗證、與窗口討論測試內容、確認規格｜3.50編輯 刪除 動作`;
            
            if (activeTab === 'ALL') {
                alert("請先切換至特定組別 (如：品檢組) 再載入範例");
                return;
            }
            
            currentDailyData[activeTab] = demoText;
            document.getElementById('rawInput').value = demoText;
            updateTabUI();
            saveCurrentReport(); 
        }

        function parseData(scroll = true) {
            parsedData = [];
            let totalTeamHours = 0;
            let hasAnyData = false;
            
            // Filtering Logic: 
            // If ALL, process all groups. 
            // If specific tab, only process that group.
            const groupsToProcess = activeTab === 'ALL' ? ALL_GROUPS : [activeTab];

            // Iterate through selected groups
            groupsToProcess.forEach(groupCode => {
                const rawContent = currentDailyData[groupCode];
                if(!rawContent || !rawContent.trim()) return;

                hasAnyData = true;
                const groupName = getGroupName(groupCode); // Get official group name
                
                const rawPeople = rawContent.split('OLD_TS').filter(item => item.trim().length > 0);

                rawPeople.forEach(personBlock => {
                    const headerMatch = personBlock.match(/^\s*(.+?)[\s\d]+小時:\s*([\d\.]+)/);
                    if (headerMatch) {
                        let originalName = headerMatch[1].trim(); 
                        let name = originalName;
                        
                        // Clean up name prefix if it exists in the raw text, 
                        // but relies on groupName for the official tag
                        ['品檢', '客服', '網頁', '技術', '美術', '資料庫'].forEach(prefix => {
                             if(name.startsWith(prefix)) name = name.substring(prefix.length).trim();
                        });

                        const totalHours = parseFloat(headerMatch[2]);
                        totalTeamHours += totalHours;

                        let taskString = personBlock.replace(headerMatch[0], '').replace(/全部摺疊\/全部展開/g, '');
                        const rawTasks = taskString.split(/編輯\s+刪除\s+動作/);
                        const tasks = [];

                        rawTasks.forEach(t => {
                            t = t.trim();
                            if (t.length === 0) return;
                            const idMatch = t.match(/#(\d+)/);
                            const id = idMatch ? idMatch[1] : '';
                            let project = '其他';
                            if (t.includes('】') && t.includes('#')) {
                                const match = t.match(/】(.*?)#/);
                                if (match) project = match[1].trim();
                            } else if (t.includes('#')) {
                                project = t.split('#')[0].replace(/【.*?】/g, '').trim();
                            } else if (t.includes('【')) {
                                const match = t.match(/【(.*?)】/);
                                if(match) project = match[1];
                            }
                            project = project.replace(/測試|支援|功能/g, '').trim();
                            const hoursMatch = t.match(/(\d+\.\d+)$/);
                            const taskHours = hoursMatch ? parseFloat(hoursMatch[1]) : 0;
                            let content = t;
                            let category = '';
                            if (idMatch) {
                                const parts = t.split('#' + id);
                                if (parts[1]) {
                                    let rightSide = parts[1];
                                    if (hoursMatch) rightSide = rightSide.substring(0, rightSide.lastIndexOf(hoursMatch[0]));
                                    rightSide = rightSide.trim();
                                    if (rightSide.startsWith(':')) rightSide = rightSide.substring(1).trim();
                                    const contentStartRegex = /(測試項目數|回報問題數|測試內容|問題回報|回報問題)/;
                                    const splitMatch = rightSide.search(contentStartRegex);
                                    if (splitMatch !== -1) {
                                        category = rightSide.substring(0, splitMatch).trim();
                                        content = rightSide.substring(splitMatch).trim();
                                    } else {
                                        category = rightSide; content = '';
                                    }
                                    if (category.endsWith('｜')) category = category.slice(0, -1).trim();
                                }
                            }
                            tasks.push({ project, category, id, content, hours: taskHours });
                        });
                        
                        // Push with explicitly derived groupName from tab
                        parsedData.push({ name, group: groupName, totalHours, tasks });
                    }
                });
            });

            // Even if we are in a tab with no data, we should render empty view
            if (!hasAnyData) {
                // If it's a specific tab, we might want to clear views, but also we are editing, 
                // so we don't want to hide everything. Just hide results.
                document.getElementById('analysisSection').classList.add('hidden');
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('headerTotalManHours').innerText = "0 人 / 0.0hr";
                
                // If ALL tab and no data anywhere, verify missing info
                if (activeTab === 'ALL') updateMissingInfoText(); 
                return;
            }

            if (parsedData.length === 0) {
                if (activeTab === 'ALL') updateMissingInfoText();
                return;
            }

            const statsText = `${parsedData.length}人 / ${totalTeamHours.toFixed(1)}hr`;
            document.getElementById('headerTotalManHours').innerText = statsText;
            document.getElementById('widgetTotalManHours').innerText = statsText;
            
            renderDashboard();
            renderDetailView();
            
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            if(scroll && activeTab !== 'ALL') {
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }
            
            if (activeTab === 'ALL') updateMissingInfoText();
        }

        // --- RENDERERS ---
        function renderDashboard() {
            const tbody = document.getElementById('hoursTableBody');
            tbody.innerHTML = '';
            const sortedData = [...parsedData].sort((a,b) => b.totalHours - a.totalHours);

            let rows = '';
            sortedData.forEach(p => {
                let barColor = 'bg-emerald-500';
                let hoursClass = 'text-emerald-700';
                if (p.totalHours < 8) { barColor = 'bg-amber-400'; hoursClass = 'text-amber-700'; }
                else if (p.totalHours > 10) { barColor = 'bg-rose-500'; hoursClass = 'text-rose-700'; }
                let width = Math.min((p.totalHours / 12) * 100, 100);

                rows += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-2 font-medium text-slate-700 text-xs">${p.name}</td>
                        <td class="p-2 align-middle">
                            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                <div class="${barColor} h-2 rounded-full" style="width: ${width}%"></div>
                            </div>
                        </td>
                        <td class="p-2 text-right font-bold font-mono text-xs ${hoursClass}">${p.totalHours.toFixed(1)}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = rows;

            const leaveContainer = document.getElementById('leaveListContainer');
            let hasLeave = false;
            let leaveHtml = `<ul class="space-y-3">`;

            parsedData.forEach(p => {
                p.tasks.forEach(t => {
                    if (t.category.includes('請假') || t.content.includes('請假') || t.category.includes('特休') || t.category.includes('事假') || t.category.includes('病假')) {
                        hasLeave = true;
                        leaveHtml += `
                            <li class="flex items-start bg-rose-50 border border-rose-100 p-2 rounded-lg">
                                <div class="bg-rose-200 text-rose-700 rounded-full w-6 h-6 flex items-center justify-center shrink-0 mr-2 font-bold text-[10px]">${p.name[0]}</div>
                                <div>
                                    <div class="font-bold text-slate-800 text-xs">${p.name}</div>
                                    <div class="text-xs text-rose-600 font-medium mt-0.5">${t.category.replace('請假', '')}</div>
                                    <div class="text-[10px] text-slate-500 font-mono inline-block">${t.hours} hr</div>
                                </div>
                            </li>
                        `;
                    }
                });
            });
            leaveHtml += `</ul>`;
            leaveContainer.innerHTML = hasLeave ? leaveHtml : `<div class="flex flex-col items-center justify-center h-full text-slate-400 py-4"><i class="fa-regular fa-calendar-check text-2xl mb-1 text-emerald-100"></i><p class="text-xs">全員出勤</p></div>`;
        }

        function formatContentForWeb(text) {
            if (!text) return '';
            const segments = text.split(/[｜|]/);
            return segments.map(seg => {
                seg = seg.trim();
                if (!seg) return '';
                if (seg.includes('項目數') || seg.includes('回報問題數')) {
                    const num = seg.match(/\d+/);
                    const n = num ? parseInt(num[0]) : 0;
                    const colorClass = n > 0 ? 'bg-red-50 text-red-600 ring-1 ring-red-200' : 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium ${colorClass} mr-2 mb-1">${seg}</span>`;
                }
                if (seg.includes('測試內容') || seg.includes('工作事項')) {
                     return `<div class="mt-1 block text-slate-600 text-xs"><span class="font-bold text-slate-700">${seg.split('：')[0]}：</span>${seg.split('：')[1] || ''}</div>`;
                }
                return `<span class="mr-2 text-slate-700">${seg}</span>`;
            }).join('');
        }

        function toggleTask(btn) {
            const container = btn.parentElement;
            const content = container.querySelector('.accordion-content');
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            
            btn.setAttribute('aria-expanded', !isExpanded);
            if (!isExpanded) {
                content.classList.add('expanded');
                content.classList.add('p-3');
                content.classList.add('pt-0');
            } else {
                content.classList.remove('expanded');
                content.classList.remove('p-3');
                content.classList.remove('pt-0');
            }
        }

        function renderDetailView() {
            const container = document.getElementById('detailView');
            container.innerHTML = '';
            parsedData.forEach((p, pIndex) => {
                let hoursColor = 'bg-emerald-100 text-emerald-800';
                if (p.totalHours < 8) hoursColor = 'bg-amber-100 text-amber-800';
                if (p.totalHours > 10) hoursColor = 'bg-rose-100 text-rose-800';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col md:flex-row overflow-hidden';
                
                // Add Group to Name Display - NOW USING p.group directly from loop source
                const displayName = p.group ? `<span class="text-xs text-slate-400 block mb-0.5">[${p.group}]</span>${p.name}` : p.name;
                
                let tasksHtml = p.tasks.map((t, tIndex) => `
                    <div class="border-b border-slate-100 last:border-0">
                        <button class="accordion-btn w-full text-left p-3 flex items-center justify-between hover:bg-slate-50 transition group focus:outline-none" onclick="toggleTask(this)" aria-expanded="false">
                            <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1 pr-4">
                                <span class="text-xs font-bold text-slate-800">${t.project}</span>
                                <span class="text-[10px] font-mono text-slate-400">#${t.id}</span>
                                <span class="text-xs text-slate-600">${t.category}</span>
                                <span class="text-xs font-bold text-corp-600 font-mono">: ${t.hours}hr</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-xs accordion-icon group-hover:text-corp-600"></i>
                        </button>
                        <div class="accordion-content bg-slate-50/50">
                            <div class="text-xs leading-relaxed pl-1 pt-2 border-t border-slate-100 border-dashed mx-3">
                                ${formatContentForWeb(t.content)}
                            </div>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-3 md:w-28 bg-slate-50 md:border-r border-b md:border-b-0 border-slate-200 flex flex-row md:flex-col items-center justify-between md:justify-center gap-2 shrink-0">
                        <div class="font-bold text-sm text-slate-800 text-center leading-tight">${displayName}</div>
                        <div class="px-2 py-0.5 rounded-full text-[10px] font-bold ${hoursColor}">${p.totalHours.toFixed(1)}h</div>
                    </div>
                    <div class="flex-1 bg-white flex flex-col">${tasksHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        // --- COPY & TOAST ---
        // Removed Copy Functionality and Buttons as requested, keeping Toast for Save status
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
