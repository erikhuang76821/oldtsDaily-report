<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團隊日報管理系統 (GS版)</title>
    <!-- CSS Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="css/tailwind.config.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-800 flex">

    <!-- Sidebar: History & Tools -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col h-full shrink-0 shadow-lg z-20 hidden md:flex transition-all duration-300" id="mainSidebar">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-layer-group text-corp-600"></i> 日報管理系統
                </h1>
                <p class="text-xs text-slate-400 mt-1">Google Sheet 直讀版</p>
            </div>
            <!-- Mobile close button -->
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div class="p-3 flex gap-2">
            <!-- Updated button for switching to previous day -->
            <button onclick="switchToPreviousDay()" class="flex-1 bg-corp-600 hover:bg-corp-800 text-white py-2 px-3 rounded-lg shadow text-sm font-bold transition flex items-center justify-center gap-2" title="前一天">
                <i class="fa-solid fa-chevron-left"></i> 切換到前日
            </button>
            <!-- New button for next day -->
            <button onclick="switchToNextDay()" class="w-10 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg shadow-sm text-sm font-bold transition flex items-center justify-center" title="後一天">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll px-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2 mt-2">歷史紀錄</h3>
            <div id="historyList" class="space-y-1">
                <!-- JS Populated -->
            </div>
        </div>

        <div class="p-4 border-t border-slate-200 bg-slate-50">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">資料管理</h3>
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition" title="匯出 JSON">
                    <i class="fa-solid fa-download"></i> 備份
                </button>
                <label class="flex-1 bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 py-1.5 rounded text-xs transition text-center cursor-pointer" title="匯入 JSON">
                    <i class="fa-solid fa-upload"></i> 還原
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)" accept=".json">
                </label>
            </div>
            <!-- Removed the clearAllData button/link -->
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full" id="mainContentScroll">
        
        <!-- Toolbar Header -->
        <header class="bg-white border-b border-slate-200 p-3 md:p-4 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm z-10 shrink-0 gap-4 md:gap-0">
            <div class="flex items-center gap-4 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 custom-scroll no-scrollbar">
                <!-- Mobile Menu Toggle -->
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-800 p-1">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>

                <!-- Date Picker -->
                <div class="flex flex-col mr-2 shrink-0">
                    <label class="text-[10px] text-slate-400 font-bold uppercase leading-none mb-1">日報日期</label>
                    <input type="date" id="reportDatePicker" class="font-bold text-base text-slate-800 bg-transparent border-none p-0 focus:ring-0 cursor-pointer h-6 w-32" onchange="handleDateChange()">
                </div>

                <div class="hidden md:block h-8 w-px bg-slate-200 mx-2 shrink-0"></div>

                <!-- Tabs (Simplified) -->
                <div class="flex items-center bg-slate-100 rounded-lg p-1 shrink-0 w-full md:w-auto">
                    <button onclick="switchTab('OVERVIEW')" id="tab-OVERVIEW" class="header-tab-btn active">
                        <i class="fa-solid fa-chart-pie"></i> 總覽報表
                    </button>
                    <!-- New Analysis Tab -->
                    <button onclick="switchTab('ANALYSIS')" id="tab-ANALYSIS" class="header-tab-btn">
                        <i class="fa-solid fa-chart-line"></i> 趨勢分析
                    </button>
                    <button onclick="switchTab('SOURCE')" id="tab-SOURCE" class="header-tab-btn">
                        <i class="fa-solid fa-table"></i> 資料來源
                    </button>
                    <button onclick="switchTab('SETTINGS')" id="tab-SETTINGS" class="header-tab-btn hidden md:flex">
                        <i class="fa-solid fa-sliders"></i> 控制台
                    </button>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-3 w-full md:w-auto justify-end mt-2 md:mt-0 shrink-0">
                <div id="headerTotalManHours" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full font-bold whitespace-nowrap">
                    尚未計算
                </div>
                <!-- Updated button to handle combined Fetch/Save -->
                <button onclick="handleHeaderAction()" class="bg-corp-600 hover:bg-corp-800 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                    <i class="fa-solid fa-arrows-rotate"></i> <span class="hidden md:inline">更新</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 bg-slate-50" id="scrollContainer">
            
            <!-- Source Settings Tab (Hidden by default) -->
            <section id="sourceSection" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="font-bold text-slate-700 text-lg mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                             <i class="fa-brands fa-google-drive"></i>
                        </span>
                        Google Sheet 來源設定
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">Google Sheet ID (試算表 ID)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="gsheetId" class="w-full border border-slate-300 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:border-green-600 transition bg-slate-50" placeholder="輸入 ID 例如: 168G3AtI3lIdgIv6q75Fz9BtM_u11yC1G-cz1NTJApbo">
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-400">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            請確保試算表權限已設為「知道連結者皆可檢視」，系統將透過公開模式讀取。
                        </p>

                        <!-- FEATURE 1: Auto Refresh Setting Block (Updated) -->
                        <div class="bg-blue-50/50 rounded-lg p-4 border border-blue-100 flex flex-col md:flex-row items-center gap-4">
                            <div class="flex items-center gap-2">
                                <!-- Removed Alarm Clock Icon -->
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chkAutoRefreshToggle" class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4" onchange="toggleAutoRefreshPanel()">
                                    <span class="text-sm font-bold text-slate-700">自動刷新設定</span>
                                </label>
                            </div>
                            
                            <div id="autoRefreshConfigPanel" class="hidden flex-1 flex flex-wrap items-center gap-2">
                                <span class="text-xs text-slate-500 ml-2">範圍:</span>
                                <select id="selAutoRefreshRange" class="border border-slate-300 rounded px-2 py-1 text-sm focus:border-blue-500 focus:outline-none cursor-pointer bg-white">
                                    <option value="3">近 3 天</option>
                                    <option value="7">近 7 天</option>
                                    <option value="30">近 1 個月</option>
                                    <option value="ALL">全部</option>
                                </select>

                                <span class="text-xs text-slate-500 ml-2">每隔</span>
                                <input type="number" id="inpAutoRefreshMinutes" value="5" min="1" class="w-16 border border-slate-300 rounded px-2 py-1 text-sm text-center font-mono focus:border-blue-500 focus:outline-none">
                                <span class="text-xs text-slate-500">分鐘</span>
                                
                                <button onclick="confirmAutoRefresh()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm transition ml-auto md:ml-0">
                                    確定並啟用
                                </button>
                            </div>

                            <div class="ml-auto">
                                <span id="badgeAutoRefreshStatus" class="text-[10px] font-bold px-2 py-1 rounded border bg-slate-100 text-slate-400 border-slate-200">
                                    <i class="fa-solid fa-circle-pause mr-1"></i> 未啟用
                                </span>
                            </div>
                        </div>
                        <!-- End Feature 1 -->

                        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 border-b border-slate-200 pb-2">欄位對應 (Column Index: A=0, B=1, C=2...)</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">日期 (Date)</label>
                                    <input type="number" id="colDate" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="0">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 text-emerald-600">組別 (Group)</label>
                                    <input type="number" id="colGroup" class="w-full border border-emerald-200 rounded px-2 py-1.5 text-sm text-center font-mono bg-emerald-50 text-emerald-700" value="1">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">填寫者 (Author)</label>
                                    <input type="number" id="colName" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="2">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">專案 (Project)</label>
                                    <input type="number" id="colProj" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="3">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">議題 (Issue)</label>
                                    <input type="number" id="colId" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="4">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">回應 (Response)</label>
                                    <input type="number" id="colContent" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="5">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">小時 (Hours)</label>
                                    <input type="number" id="colHours" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="6">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 text-indigo-600">連結 (Link)</label>
                                    <input type="number" id="colLink" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm text-center font-mono bg-indigo-50 text-indigo-700" value="7">
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex items-center justify-between">
                            <div id="gsheetStatusMsg" class="text-sm font-medium"></div>
                            <button onclick="fetchGoogleSheetData()" id="btnFetchGSheet" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-green-600/20 transition flex items-center gap-2 transform hover:-translate-y-0.5">
                                <i class="fa-solid fa-cloud-arrow-down"></i> 讀取資料
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Preview (Debug) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                      <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-500 text-sm">原始資料預覽 (Debug)</h3>
                        <span id="rawDataCount" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">0 筆資料</span>
                      </div>
                      <textarea id="rawJsonPreview" class="w-full h-32 p-3 border border-slate-200 rounded-lg text-xs font-mono bg-slate-50 text-slate-500 resize-none focus:outline-none" readonly placeholder="讀取後的資料將顯示於此..."></textarea>
                </div>
            </section>

            <!-- Analysis Trend Tab (NEW) -->
            <section id="analysisTabSection" class="hidden max-w-5xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <h2 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center">
                                 <i class="fa-solid fa-chart-line"></i>
                            </span>
                            趨勢分析
                        </h2>
                        
                        <!-- Controls -->
                        <div class="flex flex-wrap gap-3 items-center">
                            <div class="flex bg-slate-100 p-1 rounded-lg">
                                <button onclick="setAnalysisMode('PROJECT')" id="btnModeProject" class="px-3 py-1.5 text-xs font-bold rounded-md transition bg-white text-corp-600 shadow-sm">專案視角</button>
                                <button onclick="setAnalysisMode('PERSON')" id="btnModePerson" class="px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-700">人員比對</button>
                                <button onclick="setAnalysisMode('GROUP')" id="btnModeGroup" class="px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-700">組別視角</button>
                            </div>
                            <!-- Reset Buttons (Dynamically shown) -->
                            <button id="btnResetPerson" onclick="resetPersonSelection()" class="hidden px-3 py-1.5 text-xs font-bold rounded-md bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition">
                                <i class="fa-solid fa-rotate-left mr-1"></i> 重置人員全選
                            </button>
                            <button id="btnResetProject" onclick="resetProjectSelection()" class="hidden px-3 py-1.5 text-xs font-bold rounded-md bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition">
                                <i class="fa-solid fa-rotate-left mr-1"></i> 重置專案全選
                            </button>
                            
                            <select id="analysisDays" onchange="renderTrendAnalysis()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 focus:outline-none focus:border-corp-600 cursor-pointer">
                                <option value="7">最近 7 天</option>
                                <option value="14">最近 14 天</option>
                                <option value="30">最近 30 天</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filter Hint (Group Focus only now, Project and Person use comparison UI) -->
                    <div id="trendFilterHint" class="hidden mb-4 bg-corp-50 border border-corp-100 text-corp-800 px-4 py-2 rounded-lg text-sm flex justify-between items-center">
                        <span id="trendFilterText" class="font-bold"></span>
                        <button onclick="clearTrendFilter()" class="text-xs bg-white border border-corp-200 hover:bg-corp-100 px-3 py-1 rounded text-corp-600 transition">
                            <i class="fa-solid fa-xmark mr-1"></i> 取消聚焦
                        </button>
                    </div>

                    <!-- Chart Container -->
                    <div class="relative h-80 w-full mb-8">
                        <canvas id="trendChart"></canvas>
                    </div>

                    <!-- Entity Selector Area (Generic for Person & Project) -->
                    <div id="entitySelectionArea" class="hidden mb-6 space-y-3">
                        <!-- Selected list hidden as requested -->
                        <div id="selectedEntityContainer" class="hidden"></div>
                        
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                            <h4 id="entitySelectionTitle" class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-1 border-b border-slate-200 pb-2">
                                <i class="fa-solid fa-plus-circle"></i> 點擊加入比對
                            </h4>
                            <div id="unselectedEntityContainer" class="flex flex-col gap-3 max-h-48 overflow-y-auto custom-scroll p-1">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Legend/Summary Hint -->
                    <div id="chartLegendHint" class="bg-orange-50 border border-orange-100 rounded-lg p-3 text-xs text-orange-800 mb-6 flex items-start gap-2">
                        <i class="fa-solid fa-lightbulb mt-0.5"></i>
                        <p>此圖表顯示所選期間內的工時堆疊變化。點擊圖表中的「長條圖區塊」可操作聚焦或移除。</p>
                    </div>

                    <!-- Trend Table -->
                    <div class="overflow-x-auto">
                        <h3 class="font-bold text-slate-600 text-sm mb-3 pl-1 border-l-4 border-corp-600">詳細數據 (小時)</h3>
                        <table class="w-full text-xs text-left text-slate-600" id="trendTable">
                            <!-- Populated by JS -->
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Tab (Control Panel) -->
            <section id="settingsSection" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="font-bold text-slate-700 text-lg mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                             <i class="fa-solid fa-sliders"></i>
                        </span>
                        控制台 (全局設定)
                    </h2>
                    
                    <!-- 1. Source Flexibility Settings (Group Merges) - NEW -->
                    <div class="space-y-4 mb-8">
                        <div class="flex flex-col md:flex-row justify-between md:items-end pb-2 border-b border-slate-100 gap-2">
                             <div>
                                 <h3 class="font-bold text-slate-600 text-sm">來源彈性設定 (組別合併)</h3>
                                 <p class="text-xs text-slate-400">設定 Google Sheet 原始組別名稱如何對應到系統顯示的組別。</p>
                             </div>
                        </div>

                        <!-- Add New Group Rule Form -->
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 flex flex-col md:flex-row gap-2 items-start md:items-center">
                            <input type="text" id="newGroupAlias" placeholder="顯示名稱 (如: 網頁)" class="border border-slate-300 rounded px-2 py-1.5 text-sm w-full md:w-1/4 focus:outline-none focus:border-indigo-500">
                            <input type="text" id="newGroupSources" placeholder="原始名稱 (逗號分隔, 如: 網頁組,網頁)" class="border border-slate-300 rounded px-2 py-1.5 text-sm w-full md:flex-1 focus:outline-none focus:border-indigo-500">
                            <button onclick="addGroupRule()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-sm font-bold shadow-sm whitespace-nowrap w-full md:w-auto">
                                <i class="fa-solid fa-plus"></i> 新增
                            </button>
                        </div>

                        <div id="groupRulesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- 2. Project Merge Rules List -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-end pb-2 border-b border-slate-100">
                             <div>
                                 <h3 class="font-bold text-slate-600 text-sm">專案合併規則</h3>
                                 <p class="text-xs text-slate-400">這些規則會自動將多個專案名稱合併為一個，影響工時統計圖表。</p>
                             </div>
                        </div>

                        <div id="mergeRulesContainer" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>

                        <div id="noRulesMsg" class="text-center py-6 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-200">
                             尚未設定合併規則。<br>請至「總覽報表」的圓餅圖區塊勾選專案進行合併。
                        </div>
                    </div>
                </div>
            </section>

            <!-- Overview Tab (Dashboard) -->
            <section id="overviewSection" class="pb-12">
                <!-- Empty State -->
                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fa-regular fa-folder-open text-5xl mb-3 opacity-30"></i>
                    <p class="text-sm">今日尚無資料，請至「資料來源設定」讀取 Google Sheet。</p>
                </div>

                <!-- Anchor for Result -->
                <a id="resultAnchor"></a> 
                
                <!-- Detail List (Re-ordered to TOP) -->
                <div id="resultSection" class="hidden space-y-4 mt-2"> <!-- Reduced top margin to mt-2 -->
                    
                    <!-- Header with Filter Buttons (Point 2 & 3) -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-200 pb-2 gap-2">
                        
                        <!-- Left side flow: Heading + Filters -->
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                            <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2 shrink-0">
                                <i class="fa-solid fa-list-check text-slate-400"></i> 彙整結果
                            </h3>
                            <!-- Filter Buttons (Now flowing immediately after heading) -->
                            <div id="groupFilterButtons" class="flex flex-wrap gap-1.5 pt-1">
                                <!-- Buttons will be injected by JS -->
                            </div>
                        </div>

                        <!-- Right side: Scroll button (Point 3) -->
                        <button onclick="scrollToAnalysis()" class="text-xs bg-corp-600 hover:bg-corp-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm whitespace-nowrap shrink-0 transform hover:-translate-y-0.5">
                            <i class="fa-solid fa-chart-column mr-1"></i> 工時統計
                        </button>
                    </div>
                    <div id="detailView" class="space-y-2"></div>
                </div>

                <!-- Dashboard Widgets (Re-ordered to BOTTOM, Full Width) -->
                <!-- Anchor for scrolling -->
                <a id="analysisAnchor"></a> 
                <div id="analysisSection" class="hidden mt-6 space-y-6"> <!-- Added space-y-6 for separation -->
                    
                    <!-- Work Hours Chart (Bar) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col w-full">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-2">
                                <i class="fa-solid fa-clock"></i>
                            </span>
                            工時統計
                            <span id="widgetTotalManHours" class="ml-auto text-xs bg-slate-100 px-2 py-1 rounded-full font-normal text-slate-500"></span>
                        </h3>
                        
                        <!-- 2-Column Grid Layout for Names -->
                        <div id="hoursGridContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 overflow-y-auto custom-scroll max-h-[500px]">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- Project Distribution Chart (Pie) - NEW ADDITION -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col w-full">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <h3 class="font-bold text-slate-700 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </span>
                                專案工時佔比
                            </h3>
                            <div class="flex gap-2" id="mergeTools">
                                <!-- Dynamic Buttons -->
                                <button id="btnCancelMerge" onclick="cancelMergeMode()" class="hidden text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1">
                                    <i class="fa-solid fa-xmark"></i> 取消
                                </button>
                                <button id="btnMergeAction" onclick="handleMergeButtonClick()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1">
                                    <i class="fa-solid fa-object-group"></i> <span>合併設定</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <!-- Chart Side -->
                            <div class="w-full md:w-1/3 relative h-56 flex items-center justify-center shrink-0">
                                <canvas id="projectPieChart"></canvas>
                            </div>
                            
                            <!-- Table Side -->
                            <div class="w-full md:w-2/3 overflow-x-auto">
                                 <table class="w-full text-sm text-left text-slate-600">
                                     <thead class="text-xs text-slate-400 uppercase bg-slate-50 border-b border-slate-100">
                                         <tr>
                                             <th id="thCheckbox" class="px-3 py-2 w-8 text-center hidden">
                                                <input type="checkbox" onclick="toggleAllProjectCheckboxes(this)" class="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                             </th>
                                             <th class="px-3 py-2">專案 (包含合併項目)</th>
                                             <th class="px-3 py-2 text-right">工時</th>
                                             <th class="px-3 py-2 text-right">比例</th>
                                         </tr>
                                     </thead>
                                     <tbody id="projectTableBody" class="divide-y divide-slate-100">
                                         <!-- Populated by JS -->
                                     </tbody>
                                 </table>
                                 <p id="mergeHint" class="hidden text-[10px] text-slate-400 mt-2 text-right text-indigo-600 font-bold bg-indigo-50 inline-block px-2 py-1 rounded ml-auto w-full md:w-auto">* 請勾選上方項目並點擊「合併選取項目」</p>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

        </div>
    </main>

    <!-- Custom Modal for Merge Input -->
    <div id="mergeDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">合併確認</h3>
                <button onclick="closeMergeDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">合併後的名稱</label>
                    <input type="text" id="mergeNameInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition" placeholder="請輸入名稱">
                </div>
                
                <div class="bg-slate-50 rounded p-3 text-xs text-slate-600">
                    <p class="font-bold mb-1 text-slate-500">即將合併以下項目：</p>
                    <ul id="mergeListPreview" class="list-disc list-inside space-y-1 text-slate-500 max-h-32 overflow-y-auto">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeMergeDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="confirmMerge()" class="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">確認合併</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal (New) -->
    <div id="confirmDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="p-6 text-center">
                <div class="w-12 h-12 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trash-can text-xl"></i>
                </div>
                <h3 class="font-bold text-slate-700 text-lg mb-2">移除規則</h3>
                <p class="text-sm text-slate-500 mb-6">確定要刪除此規則嗎？</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeConfirmDialog()" class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-100 transition flex-1">取消</button>
                    <button onclick="executeDeleteRule()" class="px-4 py-2 rounded-lg text-sm font-bold bg-rose-600 text-white hover:bg-rose-700 transition flex-1 shadow-lg shadow-rose-200">確認刪除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Alias Modal (New) -->
    <div id="editDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">編輯名稱</h3>
                <button onclick="closeEditDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <label class="block text-xs font-bold text-slate-500 mb-1">合併後的顯示名稱</label>
                <input type="text" id="editAliasInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition">
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeEditDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="saveEditedProjectRule()" class="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">儲存</button>
            </div>
        </div>
    </div>

    <!-- Edit Group Rule Modal (New) -->
    <div id="editGroupDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">編輯來源規則</h3>
                <button onclick="closeEditGroupDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">顯示名稱 (Alias)</label>
                    <input type="text" id="editGroupAliasInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-emerald-500 transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">原始名稱 (逗號分隔)</label>
                    <input type="text" id="editGroupSourcesInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-emerald-500 transition">
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeEditGroupDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="saveEditedGroupRule()" class="px-4 py-2 rounded text-sm font-bold bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- Floating Buttons Container (FEATURE 2) -->
    <!-- Up Arrow (Back to Top / Result) - Now at bottom-24 -->
    <button onclick="scrollToResult()" id="backToResultBtn" class="fixed bottom-24 right-5 md:bottom-24 md:right-10 bg-corp-600 hover:bg-corp-800 text-white w-12 h-12 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-50 opacity-0 transform translate-y-5">
        <i class="fa-solid fa-arrow-up text-xl"></i>
    </button>

    <!-- Down Arrow (Go to Analysis) - Now at bottom-5 (Swapped Position, Matching Style, Larger Icon) -->
    <button onclick="scrollToAnalysis()" id="goToAnalysisBtn" class="fixed bottom-5 right-5 md:bottom-5 md:right-10 bg-corp-600 hover:bg-corp-800 text-white w-12 h-12 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-50 transform translate-y-0">
        <i class="fa-solid fa-arrow-down text-xl"></i>
    </button>

    <!-- 模塊化 JavaScript -->
    <script type="module" src="js/app.js"></script>

    <!-- Legacy Script (Fallback for older browsers) -->
    <script nomodule>
        alert('您的瀏覽器不支援 ES6 模塊。請使用最新版本的 Chrome、Firefox、Safari 或 Edge 瀏覽器。');
    </script>

    <!-- REMOVED OLD INLINE JAVASCRIPT - NOW IN SEPARATE MODULES:
        - js/config.js: 配置與常量
        - js/state.js: 全域狀態管理
        - js/storage.js: 資料存儲
        - js/utils.js: 工具函數
        - js/api.js: Google Sheets API
        - js/autoRefresh.js: 自動刷新功能
        - js/charts.js: 圖表渲染
        - js/ui.js: UI 操作
        - js/filters.js: 篩選功能
        - js/rules.js: 規則管理
        - js/app.js: 主程式入口
    OLD CODE WAS HERE (Line 588-2474, ~1886 lines) --> 
</body>
</html>
