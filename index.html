<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>團隊日報管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { 50: '#f0f9ff', 100: '#e0f2fe', 600: '#0284c7', 800: '#075985' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .active-date { background-color: #e0f2fe; border-right: 4px solid #0284c7; color: #075985; font-weight: bold; }
        
        /* Button Styles */
        .header-tab-btn { 
            @apply px-4 py-2 text-sm font-bold rounded-lg transition-all duration-200 flex items-center gap-2 text-slate-500 whitespace-nowrap relative border border-transparent flex-1 justify-center md:flex-none; 
        }
        
        /* State: Hover */
        .header-tab-btn:hover:not(.active) {
            @apply bg-slate-100 text-slate-700;
        }

        /* State: Active (Selected) - High Contrast */
        .header-tab-btn.active { 
            @apply bg-corp-600 text-white shadow-md; 
        }

        /* Filter Button Styles */
        .filter-btn {
            @apply text-[10px] font-bold px-2 py-1 rounded transition bg-slate-100 text-slate-600 hover:bg-corp-100 hover:text-corp-600 border border-transparent;
        }
        .filter-btn.active {
            @apply bg-corp-600 text-white border-corp-600;
        }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.expanded {
            max-height: 1000px; 
            opacity: 1;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-btn[aria-expanded="true"] .accordion-icon {
            transform: rotate(180deg);
        }

        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Highlight animation for anchor jump */
        @keyframes highlight-fade {
            0% { background-color: #fef3c7; transform: scale(1.02); }
            50% { background-color: #fef3c7; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .highlight-card {
            animation: highlight-fade 2s ease-out;
        }

    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-800 flex">

    <!-- Sidebar: History & Tools -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col h-full shrink-0 shadow-lg z-20 hidden md:flex transition-all duration-300" id="mainSidebar">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-layer-group text-corp-600"></i> 日報管理系統
                </h1>
                <p class="text-xs text-slate-400 mt-1">Google Sheet 直讀版</p>
            </div>
            <!-- Mobile close button -->
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div class="p-3 flex gap-2">
            <!-- Updated button for switching to previous day -->
            <button onclick="switchToPreviousDay()" class="flex-1 bg-corp-600 hover:bg-corp-800 text-white py-2 px-3 rounded-lg shadow text-sm font-bold transition flex items-center justify-center gap-2" title="前一天">
                <i class="fa-solid fa-chevron-left"></i> 切換到前日
            </button>
            <!-- New button for next day -->
            <button onclick="switchToNextDay()" class="w-10 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg shadow-sm text-sm font-bold transition flex items-center justify-center" title="後一天">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll px-3">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-2 mt-2">歷史紀錄</h3>
            <div id="historyList" class="space-y-1">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- 移除原有的資料管理區塊 (Point 2) -->
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full" id="mainContentScroll">
        
        <!-- Toolbar Header -->
        <header class="bg-white border-b border-slate-200 p-3 md:p-4 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm z-10 shrink-0 gap-4 md:gap-0">
            <div class="flex items-center gap-4 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 custom-scroll no-scrollbar">
                <!-- Mobile Menu Toggle -->
                <button onclick="toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-800 p-1">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>

                <!-- Date Picker -->
                <div class="flex flex-col mr-2 shrink-0">
                    <label class="text-[10px] text-slate-400 font-bold uppercase leading-none mb-1">日報日期</label>
                    <input type="date" id="reportDatePicker" class="font-bold text-base text-slate-800 bg-transparent border-none p-0 focus:ring-0 cursor-pointer h-6 w-32" onchange="handleDateChange()">
                </div>

                <div class="hidden md:block h-8 w-px bg-slate-200 mx-2 shrink-0"></div>

                <!-- Tabs (Simplified) -->
                <div class="flex items-center bg-slate-100 rounded-lg p-1 shrink-0 w-full md:w-auto">
                    <button onclick="switchTab('OVERVIEW')" id="tab-OVERVIEW" class="header-tab-btn active">
                        <i class="fa-solid fa-chart-pie"></i> 總覽報表
                    </button>
                    <!-- New Analysis Tab -->
                    <button onclick="switchTab('ANALYSIS')" id="tab-ANALYSIS" class="header-tab-btn">
                        <i class="fa-solid fa-chart-line"></i> 趨勢分析
                    </button>
                    <button onclick="switchTab('SOURCE')" id="tab-SOURCE" class="header-tab-btn">
                        <i class="fa-solid fa-table"></i> 資料來源
                    </button>
                    <button onclick="switchTab('SETTINGS')" id="tab-SETTINGS" class="header-tab-btn hidden md:flex">
                        <i class="fa-solid fa-sliders"></i> 控制台
                    </button>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-3 w-full md:w-auto justify-end mt-2 md:mt-0 shrink-0">
                <div id="headerTotalManHours" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full font-bold whitespace-nowrap">
                    尚未計算
                </div>
                <!-- Updated button to handle combined Fetch/Save -->
                <button onclick="handleHeaderAction()" class="bg-corp-600 hover:bg-corp-800 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                    <i class="fa-solid fa-arrows-rotate"></i> <span class="hidden md:inline">更新</span>
                </button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 space-y-6 bg-slate-50" id="scrollContainer">
            
            <!-- Source Settings Tab (Hidden by default) -->
            <section id="sourceSection" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="font-bold text-slate-700 text-lg mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                             <i class="fa-brands fa-google-drive"></i>
                        </span>
                        Google Sheet 來源設定
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">Google Sheet ID (試算表 ID)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="gsheetId" class="w-full border border-slate-300 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:border-green-600 transition bg-slate-50" placeholder="輸入 ID 例如: -">
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-400">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            請確保試算表權限已設為「知道連結者皆可檢視」，系統將透過公開模式讀取。
                        </p>

                        <!-- FEATURE 1: Auto Refresh Setting Block (Updated) -->
                        <div class="bg-blue-50/50 rounded-lg p-4 border border-blue-100 flex flex-col md:flex-row items-center gap-4">
                            <div class="flex items-center gap-2">
                                <!-- Removed Alarm Clock Icon -->
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <!-- 預設勾選 (checked) -->
                                    <input type="checkbox" id="chkAutoRefreshToggle" class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4" onchange="toggleAutoRefreshPanel()" checked>
                                    <span class="text-sm font-bold text-slate-700">自動刷新設定</span>
                                </label>
                            </div>
                            
                            <!-- 預設顯示 (移除 hidden) -->
                            <div id="autoRefreshConfigPanel" class="flex flex-1 flex flex-wrap items-center gap-2">
                                <span class="text-xs text-slate-500 ml-2">範圍:</span>
                                <select id="selAutoRefreshRange" class="border border-slate-300 rounded px-2 py-1 text-sm focus:border-blue-500 focus:outline-none cursor-pointer bg-white">
                                    <option value="4" selected>近 4 天</option>
                                    <option value="7">近 7 天</option>
                                    <option value="30">近 1 個月</option>
                                    <option value="ALL">全部</option>
                                </select>

                                <span class="text-xs text-slate-500 ml-2">每隔</span>
                                <!-- 預設 10 分鐘 -->
                                <input type="number" id="inpAutoRefreshMinutes" value="10" min="1" class="w-16 border border-slate-300 rounded px-2 py-1 text-sm text-center font-mono focus:border-blue-500 focus:outline-none">
                                <span class="text-xs text-slate-500">分鐘</span>
                                
                                <button onclick="confirmAutoRefresh()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm transition ml-auto md:ml-0">
                                    確定並啟用
                                </button>
                            </div>

                            <div class="ml-auto">
                                <span id="badgeAutoRefreshStatus" class="text-[10px] font-bold px-2 py-1 rounded border bg-slate-100 text-slate-400 border-slate-200">
                                    <i class="fa-solid fa-circle-pause mr-1"></i> 未啟用
                                </span>
                            </div>
                        </div>
                        <!-- End Feature 1 -->

                        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-3 border-b border-slate-200 pb-2">欄位對應 (Column Index: A=0, B=1, C=2...)</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">日期 (Date)</label>
                                    <input type="number" id="colDate" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="0">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 text-emerald-600">組別 (Group)</label>
                                    <input type="number" id="colGroup" class="w-full border border-emerald-200 rounded px-2 py-1.5 text-sm text-center font-mono bg-emerald-50 text-emerald-700" value="8">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">填寫者 (Author)</label>
                                    <input type="number" id="colName" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="2">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">專案 (Project)</label>
                                    <input type="number" id="colProj" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="3">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">議題 (Issue)</label>
                                    <input type="number" id="colId" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="4">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">回應 (Response)</label>
                                    <input type="number" id="colContent" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="5">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">小時 (Hours)</label>
                                    <input type="number" id="colHours" class="w-full border rounded px-2 py-1.5 text-sm text-center font-mono" value="6">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 text-indigo-600">連結 (Link)</label>
                                    <input type="number" id="colLink" class="w-full border border-indigo-200 rounded px-2 py-1.5 text-sm text-center font-mono bg-indigo-50 text-indigo-700" value="7">
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex items-center justify-between gap-4">
                            <div id="gsheetStatusMsg" class="text-sm font-medium mr-auto"></div>
                            
                            <!-- 新增：紅色讀取全部按鈕 (Point 4) -->
                            <button onclick="openReadAllConfirm()" class="bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 hover:border-rose-300 px-4 py-2.5 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2 transform hover:-translate-y-0.5" title="讀取所有歷史資料">
                                <i class="fa-solid fa-layer-group"></i> <span class="hidden md:inline">讀取全部</span>
                            </button>

                            <!-- 修改：讀取當日資料 (Point 3) -->
                            <button onclick="fetchGoogleSheetData()" id="btnFetchGSheet" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-green-600/20 transition flex items-center gap-2 transform hover:-translate-y-0.5">
                                <i class="fa-solid fa-cloud-arrow-down"></i> 讀取當日資料
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Preview (Debug) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                      <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-500 text-sm">原始資料預覽 (Debug)</h3>
                        <span id="rawDataCount" class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">0 筆資料</span>
                      </div>
                      <textarea id="rawJsonPreview" class="w-full h-32 p-3 border border-slate-200 rounded-lg text-xs font-mono bg-slate-50 text-slate-500 resize-none focus:outline-none" readonly placeholder="讀取後的資料將顯示於此..."></textarea>
                </div>
            </section>

            <!-- Analysis Trend Tab (NEW) -->
            <section id="analysisTabSection" class="hidden max-w-5xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <h2 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center">
                                 <i class="fa-solid fa-chart-line"></i>
                            </span>
                            趨勢分析
                        </h2>
                        
                        <!-- Controls -->
                        <div class="flex flex-wrap gap-3 items-center">
                            <div class="flex bg-slate-100 p-1 rounded-lg">
                                <button onclick="setAnalysisMode('PROJECT')" id="btnModeProject" class="px-3 py-1.5 text-xs font-bold rounded-md transition bg-white text-corp-600 shadow-sm">專案視角</button>
                                <button onclick="setAnalysisMode('PERSON')" id="btnModePerson" class="px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-700">人員比對</button>
                                <button onclick="setAnalysisMode('GROUP')" id="btnModeGroup" class="px-3 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-700">組別視角</button>
                            </div>
                            <!-- Reset Buttons (Dynamically shown) -->
                            <button id="btnResetPerson" onclick="resetPersonSelection()" class="hidden px-3 py-1.5 text-xs font-bold rounded-md bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition">
                                <i class="fa-solid fa-rotate-left mr-1"></i> 重置人員全選
                            </button>
                            <button id="btnResetProject" onclick="resetProjectSelection()" class="hidden px-3 py-1.5 text-xs font-bold rounded-md bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition">
                                <i class="fa-solid fa-rotate-left mr-1"></i> 重置專案全選
                            </button>
                            
                            <select id="analysisDays" onchange="renderTrendAnalysis()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 focus:outline-none focus:border-corp-600 cursor-pointer">
                                <option value="7">最近 7 天</option>
                                <option value="14">最近 14 天</option>
                                <option value="30">最近 30 天</option>
                                <option value="90">最近 3 個月</option>
                                <option value="180">最近 6 個月</option>
                                <option value="365">最近 1 年</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filter Hint (Group Focus only now, Project and Person use comparison UI) -->
                    <div id="trendFilterHint" class="hidden mb-4 bg-corp-50 border border-corp-100 text-corp-800 px-4 py-2 rounded-lg text-sm flex justify-between items-center">
                        <span id="trendFilterText" class="font-bold"></span>
                        <button onclick="clearTrendFilter()" class="text-xs bg-white border border-corp-200 hover:bg-corp-100 px-3 py-1 rounded text-corp-600 transition">
                            <i class="fa-solid fa-xmark mr-1"></i> 取消聚焦
                        </button>
                    </div>

                    <!-- Chart Container -->
                    <div class="relative h-80 w-full mb-8">
                        <canvas id="trendChart"></canvas>
                    </div>

                    <!-- Entity Selector Area (Generic for Person & Project) -->
                    <div id="entitySelectionArea" class="hidden mb-6 space-y-3">
                        <!-- Selected list hidden as requested -->
                        <div id="selectedEntityContainer" class="hidden"></div>
                        
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                            <h4 id="entitySelectionTitle" class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-1 border-b border-slate-200 pb-2">
                                <i class="fa-solid fa-plus-circle"></i> 點擊加入比對
                            </h4>
                            <div id="unselectedEntityContainer" class="flex flex-col gap-3 max-h-48 overflow-y-auto custom-scroll p-1">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Legend/Summary Hint -->
                    <div id="chartLegendHint" class="bg-orange-50 border border-orange-100 rounded-lg p-3 text-xs text-orange-800 mb-6 flex items-start gap-2">
                        <i class="fa-solid fa-lightbulb mt-0.5"></i>
                        <p>此圖表顯示所選期間內的工時堆疊變化。點擊圖表中的「長條圖區塊」可操作聚焦或移除。</p>
                    </div>

                    <!-- Trend Table -->
                    <div class="overflow-x-auto">
                        <h3 class="font-bold text-slate-600 text-sm mb-3 pl-1 border-l-4 border-corp-600">詳細數據 (小時)</h3>
                        <table class="w-full text-xs text-left text-slate-600" id="trendTable">
                            <!-- Populated by JS -->
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Tab (Control Panel) -->
            <section id="settingsSection" class="hidden max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="font-bold text-slate-700 text-lg flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                                <i class="fa-solid fa-sliders"></i>
                            </span>
                            控制台 (全局設定)
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="exportSettings()" class="text-xs bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-download"></i> 匯出設定
                            </button>
                            <label class="text-xs bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1 cursor-pointer">
                                <i class="fa-solid fa-upload"></i> 匯入設定
                                <input type="file" id="importSettingsFile" class="hidden" onchange="importSettings(this)" accept=".json">
                            </label>
                        </div>
                    </div>
                    
                    <!-- 1. Source Flexibility Settings (Group Merges) - NEW -->
                    <div class="space-y-4 mb-8">
                        <div class="flex flex-col md:flex-row justify-between md:items-end pb-2 border-b border-slate-100 gap-2">
                             <div>
                                 <h3 class="font-bold text-slate-600 text-sm">來源彈性設定 (組別合併)</h3>
                                 <p class="text-xs text-slate-400">設定 Google Sheet 原始組別名稱如何對應到系統顯示的組別。</p>
                             </div>
                        </div>

                        <!-- Add New Group Rule Form -->
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 flex flex-col md:flex-row gap-2 items-start md:items-center">
                            <input type="text" id="newGroupAlias" placeholder="顯示名稱 (如: 網頁)" class="border border-slate-300 rounded px-2 py-1.5 text-sm w-full md:w-1/4 focus:outline-none focus:border-indigo-500">
                            <input type="text" id="newGroupSources" placeholder="原始名稱 (逗號分隔, 如: 網頁組,網頁)" class="border border-slate-300 rounded px-2 py-1.5 text-sm w-full md:flex-1 focus:outline-none focus:border-indigo-500">
                            <button onclick="addGroupRule()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-sm font-bold shadow-sm whitespace-nowrap w-full md:w-auto">
                                <i class="fa-solid fa-plus"></i> 新增
                            </button>
                        </div>

                        <div id="groupRulesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- 2. Project Merge Rules List -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-end pb-2 border-b border-slate-100">
                             <div>
                                 <h3 class="font-bold text-slate-600 text-sm">專案合併規則</h3>
                                 <p class="text-xs text-slate-400">這些規則會自動將多個專案名稱合併為一個，影響工時統計圖表。</p>
                             </div>
                        </div>

                        <div id="mergeRulesContainer" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>

                        <div id="noRulesMsg" class="text-center py-6 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-200">
                             尚未設定合併規則。<br>請至「總覽報表」的圓餅圖區塊勾選專案進行合併。
                        </div>
                    </div>
                </div>
            </section>

            <!-- Overview Tab (Dashboard) -->
            <section id="overviewSection" class="pb-12">
                <!-- Empty State -->
                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fa-regular fa-folder-open text-5xl mb-3 opacity-30"></i>
                    <p class="text-sm">今日尚無資料，請至「資料來源設定」讀取 Google Sheet。</p>
                </div>

                <!-- Anchor for Result -->
                <a id="resultAnchor"></a> 
                
                <!-- Detail List (Re-ordered to TOP) -->
                <div id="resultSection" class="hidden space-y-4 mt-2"> <!-- Reduced top margin to mt-2 -->
                    
                    <!-- Header with Filter Buttons (Point 2 & 3) -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-200 pb-2 gap-2">
                        
                        <!-- Left side flow: Heading + Filters -->
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                            <h3 class="font-bold text-slate-700 text-lg flex items-center gap-2 shrink-0">
                                <i class="fa-solid fa-list-check text-slate-400"></i> 彙整結果
                            </h3>
                            <!-- Filter Buttons (Now flowing immediately after heading) -->
                            <div id="groupFilterButtons" class="flex flex-wrap gap-1.5 pt-1">
                                <!-- Buttons will be injected by JS -->
                            </div>
                        </div>

                        <!-- Right side: Actions -->
                        <div class="flex items-center gap-2 shrink-0">
                            <!-- New Button for QA Project (Visible only in '品檢' filter) -->
                            <a href="https://erikhuang76821.github.io/QA_project/" target="_blank" id="btnQaLink" class="hidden text-xs bg-corp-600 hover:bg-corp-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm whitespace-nowrap transform hover:-translate-y-0.5 items-center gap-2 decoration-0">
                                <i class="fa-solid fa-briefcase"></i> 案件管理
                            </a>
                            <button onclick="scrollToAnalysis()" class="text-xs bg-corp-600 hover:bg-corp-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm whitespace-nowrap transform hover:-translate-y-0.5">
                                <i class="fa-solid fa-chart-column mr-1"></i> 工時統計
                            </button>
                        </div>
                    </div>
                    <div id="detailView" class="space-y-2"></div>
                </div>

                <!-- Dashboard Widgets (Re-ordered to BOTTOM, Full Width) -->
                <!-- Anchor for scrolling -->
                <a id="analysisAnchor"></a> 
                <div id="analysisSection" class="hidden mt-6 space-y-6"> <!-- Added space-y-6 for separation -->
                    
                    <!-- Work Hours Chart (Bar) -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col w-full">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center mr-2">
                                <i class="fa-solid fa-clock"></i>
                            </span>
                            工時統計
                            <span id="widgetTotalManHours" class="ml-auto text-xs bg-slate-100 px-2 py-1 rounded-full font-normal text-slate-500"></span>
                        </h3>
                        
                        <!-- 2-Column Grid Layout for Names -->
                        <div id="hoursGridContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 overflow-y-auto custom-scroll max-h-[500px]">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- Project Distribution Chart (Pie) - NEW ADDITION -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col w-full">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <h3 class="font-bold text-slate-700 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </span>
                                專案工時佔比
                            </h3>
                            <div class="flex gap-2" id="mergeTools">
                                <!-- Dynamic Buttons -->
                                <button id="btnCancelMerge" onclick="cancelMergeMode()" class="hidden text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1">
                                    <i class="fa-solid fa-xmark"></i> 取消
                                </button>
                                <button id="btnMergeAction" onclick="handleMergeButtonClick()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded transition font-bold shadow-sm flex items-center gap-1">
                                    <i class="fa-solid fa-object-group"></i> <span>合併設定</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <!-- Chart Side -->
                            <div class="w-full md:w-1/3 relative h-56 flex items-center justify-center shrink-0">
                                <canvas id="projectPieChart"></canvas>
                            </div>
                            
                            <!-- Table Side -->
                            <div class="w-full md:w-2/3 overflow-x-auto">
                                 <table class="w-full text-sm text-left text-slate-600">
                                     <thead class="text-xs text-slate-400 uppercase bg-slate-50 border-b border-slate-100">
                                         <tr>
                                             <th id="thCheckbox" class="px-3 py-2 w-8 text-center hidden">
                                                <input type="checkbox" onclick="toggleAllProjectCheckboxes(this)" class="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                             </th>
                                             <th class="px-3 py-2">專案 (包含合併項目)</th>
                                             <th class="px-3 py-2 text-right">工時</th>
                                             <th class="px-3 py-2 text-right">比例</th>
                                         </tr>
                                     </thead>
                                     <tbody id="projectTableBody" class="divide-y divide-slate-100">
                                         <!-- Populated by JS -->
                                     </tbody>
                                 </table>
                                 <p id="mergeHint" class="hidden text-[10px] text-slate-400 mt-2 text-right text-indigo-600 font-bold bg-indigo-50 inline-block px-2 py-1 rounded ml-auto w-full md:w-auto">* 請勾選上方項目並點擊「合併選取項目」</p>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

        </div>
    </main>

    <!-- Custom Modal for Merge Input -->
    <div id="mergeDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">合併確認</h3>
                <button onclick="closeMergeDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">合併後的名稱</label>
                    <input type="text" id="mergeNameInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition" placeholder="請輸入名稱">
                </div>
                
                <div class="bg-slate-50 rounded p-3 text-xs text-slate-600">
                    <p class="font-bold mb-1 text-slate-500">即將合併以下項目：</p>
                    <ul id="mergeListPreview" class="list-disc list-inside space-y-1 text-slate-500 max-h-32 overflow-y-auto">
                        <!-- Items -->
                    </ul>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeMergeDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="confirmMerge()" class="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">確認合併</button>
            </div>
        </div>
    </div>

    <!-- Generalized Confirm Modal (Replaced Delete Modal) -->
    <div id="confirmDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="p-6 text-center">
                <div class="w-12 h-12 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center mx-auto mb-4" id="confirmIconContainer">
                    <i class="fa-solid fa-circle-question text-xl"></i>
                </div>
                <h3 class="font-bold text-slate-700 text-lg mb-2" id="confirmTitle">確認操作</h3>
                <p class="text-sm text-slate-500 mb-6" id="confirmMessage">確定要執行此操作嗎？</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeConfirmDialog()" class="px-4 py-2 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-100 transition flex-1">取消</button>
                    <button onclick="executeConfirm()" id="confirmActionBtn" class="px-4 py-2 rounded-lg text-sm font-bold bg-corp-600 text-white hover:bg-corp-700 transition flex-1 shadow-lg shadow-corp-200">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Alias Modal (New) -->
    <div id="editDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">編輯名稱</h3>
                <button onclick="closeEditDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <label class="block text-xs font-bold text-slate-500 mb-1">合併後的顯示名稱</label>
                <input type="text" id="editAliasInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition">
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeEditDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="saveEditedProjectRule()" class="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">儲存</button>
            </div>
        </div>
    </div>

    <!-- Edit Group Rule Modal (New) -->
    <div id="editGroupDialogOverlay" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[scale-in_0.2s_ease-out]">
            <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">編輯來源規則</h3>
                <button onclick="closeEditGroupDialog()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">顯示名稱 (Alias)</label>
                    <input type="text" id="editGroupAliasInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-emerald-500 transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">原始名稱 (逗號分隔)</label>
                    <input type="text" id="editGroupSourcesInput" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-emerald-500 transition">
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end gap-2 border-t border-slate-100">
                <button onclick="closeEditGroupDialog()" class="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="saveEditedGroupRule()" class="px-4 py-2 rounded text-sm font-bold bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">儲存</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- Floating Buttons Container (FEATURE 2) -->
    <!-- Up Arrow (Back to Top / Result) - Now at bottom-24 -->
    <button onclick="scrollToResult()" id="backToResultBtn" class="fixed bottom-24 right-5 md:bottom-24 md:right-10 bg-corp-600 hover:bg-corp-800 text-white w-12 h-12 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-50 opacity-0 transform translate-y-5 hidden">
        <i class="fa-solid fa-arrow-up text-xl"></i>
    </button>

    <!-- Down Arrow (Go to Analysis) - Now at bottom-5 (Swapped Position, Matching Style, Larger Icon) -->
    <button onclick="scrollToAnalysis()" id="goToAnalysisBtn" class="fixed bottom-5 right-5 md:bottom-5 md:right-10 bg-corp-600 hover:bg-corp-800 text-white w-12 h-12 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-50 transform translate-y-0 hidden">
        <i class="fa-solid fa-arrow-down text-xl"></i>
    </button>

    <script>
        // --- HELPER FUNCTION ---
        // Function to convert column index to letter (0->A, 1->B, etc.)
        function getColLetter(index) {
            let letter = '';
            while (index >= 0) {
                letter = String.fromCharCode((index % 26) + 65) + letter;
                index = Math.floor(index / 26) - 1;
            }
            return letter;
        }

        // --- STORAGE & STATE MANAGER ---
        const DB_KEY = 'daily_reports_db_v6_gs_clean'; 
        const SETTINGS_KEY = 'daily_reports_settings_v1';
        let currentReportDate = '';
        let projectChartInstance = null; // Store chart instance
        let trendChartInstance = null; // Store trend chart instance (New)
        let isMergeMode = false; // Track if we are in merge selection mode
        
        let ruleToDeleteIndex = -1; // Track index for deletion (Legacy use inside confirm)
        let ruleToEditIndex = -1; // Track index for editing
        let ruleToEditGroupIndex = -1; // Track index for editing group rules
        let deleteType = ''; // 'project' or 'group'
        let onConfirmAction = null; // Callback for generic confirm modal

        let autoRefreshTimer = null; // FEATURE 1: Timer ID
        
        // Analysis State
        let analysisMode = 'PROJECT'; // 'PROJECT', 'PERSON', or 'GROUP'
        let activeTrendFilter = null; // Store current drill-down filter (e.g., 'John', 'Project A')
        let selectedPersons = new Set(); // New: Set to store selected people for comparison
        let shouldSelectAllPersons = false; // Flag to select all persons on first switch to PERSON mode
        
        let selectedProjects = new Set(); // Comparison set for Projects
        let shouldSelectAllProjects = true; // Flag to select all projects on first switch (Default true to load data on start)

        let currentTotalEntitiesCount = 0; // NEW: To track total count for "Select All" logic (shared context)
        
        // Data Model
        let currentDailyData = {
            config: {
                sheetId: '',
                cols: { date: 0, group: 8, name: 2, proj: 3, id: 4, content: 5, hours: 6, link: 7 } 
            },
            rows: []
        };
        
        // Default Group Merges requested by user
        const DEFAULT_GROUP_MERGES = [
            { alias: '品檢', originals: ['品檢組', '品檢','品檢_早班','品檢_中班','品檢_緯創'] },
            { alias: '技術', originals: ['技術', '技術組'] },
            { alias: '網頁系統', originals: ['網頁系統_前端', '網頁系統_後端','網頁系統','網頁系統_實習生','網頁系統_外包','網頁系統_緯創'] },
            { alias: '資料庫', originals: ['資料庫組', '資料庫','資料庫_智能行銷'] },
            { alias: '資源整合應用', originals: ['資源整合應用_自動化', '資源整合應用_企劃'] },
            { alias: '客服', originals: ['客服組', '【客服組】','客服_VIP','客服_值班者'] }
        ];

        // Global Settings Model
        let globalSettings = {
            projectMerges: [],
            groupMerges: []
        };
        
        let activeTab = 'OVERVIEW'; 
        let activeFilterGroup = 'ALL'; 

        // Chart Colors Palette
        const CHART_COLORS = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#84cc16', '#6366f1', '#14b8a6',
            '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e', '#eab308'
        ];
        function getColor(index) { return CHART_COLORS[index % CHART_COLORS.length]; }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalSettings();
            const today = new Date().toISOString().split('T')[0];
            updateHistoryList();
            loadReportByDate(today);
            
            // --- 預設自動刷新邏輯開始 ---
            fetchGoogleSheetData('3');
            startAutoRefresh(10, '3');
            // --- 預設自動刷新邏輯結束 ---

            // Initial scroll listener setup
            const scrollContainer = document.getElementById('scrollContainer');
            if (scrollContainer) {
                scrollContainer.addEventListener('scroll', handleScroll);
                handleScroll();
            }
            
            if (currentDailyData.rows.length === 0) {
                switchTab('SOURCE');
            }
            
            setAnalysisMode('PROJECT'); 
        });

        // --- GLOBAL SETTINGS ---
        function loadGlobalSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                globalSettings = JSON.parse(stored);
                if (!globalSettings.projectMerges) globalSettings.projectMerges = [];
                if (!globalSettings.groupMerges) globalSettings.groupMerges = JSON.parse(JSON.stringify(DEFAULT_GROUP_MERGES));
            } else {
                globalSettings.groupMerges = JSON.parse(JSON.stringify(DEFAULT_GROUP_MERGES));
                saveGlobalSettings();
            }
        }

        function saveGlobalSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(globalSettings));
            renderSettingsTab(); // Update UI
        }

        // --- FEATURE 1: AUTO REFRESH LOGIC ---
        function toggleAutoRefreshPanel() {
            const chk = document.getElementById('chkAutoRefreshToggle');
            const panel = document.getElementById('autoRefreshConfigPanel');
            if (chk.checked) {
                panel.classList.remove('hidden');
                panel.classList.add('flex');
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('flex');
                stopAutoRefresh();
            }
        }

        function confirmAutoRefresh() {
            const mins = parseInt(document.getElementById('inpAutoRefreshMinutes').value);
            const range = document.getElementById('selAutoRefreshRange').value;
            
            if (!mins || mins < 1) {
                showToast('請輸入有效的分鐘數 (至少 1 分鐘)');
                return;
            }
            
            startAutoRefresh(mins, range);
        }

        function startAutoRefresh(minutes, range) {
            stopAutoRefresh(); 
            
            const badge = document.getElementById('badgeAutoRefreshStatus');
            badge.className = "text-[10px] font-bold px-2 py-1 rounded border bg-green-100 text-green-600 border-green-200 animate-pulse";
            badge.innerHTML = `<i class="fa-solid fa-circle-play mr-1"></i> 每 ${minutes} 分鐘刷新`;
            
            let rangeLabel = '全部';
            if (range === '3') rangeLabel = '近3天';
            if (range === '7') rangeLabel = '近7天';
            if (range === '30') rangeLabel = '近1月';
            
            showToast(`已啟用自動刷新 (每 ${minutes} 分鐘, 範圍: ${rangeLabel})`);
            
            autoRefreshTimer = setInterval(() => {
                const id = document.getElementById('gsheetId').value;
                if(id) {
                    fetchGoogleSheetData(range); 
                }
            }, minutes * 60 * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            const badge = document.getElementById('badgeAutoRefreshStatus');
            badge.className = "text-[10px] font-bold px-2 py-1 rounded border bg-slate-100 text-slate-400 border-slate-200";
            badge.innerHTML = `<i class="fa-solid fa-circle-pause mr-1"></i> 未啟用`;
        }

        // --- SCROLL LISTENERS & ACTIONS ---
        function handleScroll() {
            const scrollContainer = document.getElementById('scrollContainer');
            const upBtn = document.getElementById('backToResultBtn'); 
            const downBtn = document.getElementById('goToAnalysisBtn'); 
            
            if (!scrollContainer) return;

            // Only act if we are in OVERVIEW tab (Point 1 fix)
            if (activeTab !== 'OVERVIEW') {
                return;
            }

            const scrollTop = scrollContainer.scrollTop;
            const scrollHeight = scrollContainer.scrollHeight;
            const clientHeight = scrollContainer.clientHeight;

            // Logic for UP Arrow
            if (scrollTop > 400) {
                upBtn.classList.remove('opacity-0', 'translate-y-5', 'hidden'); // ensure not hidden
                upBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                upBtn.classList.remove('opacity-100', 'translate-y-0');
                upBtn.classList.add('opacity-0', 'translate-y-5');
            }

            // Logic for DOWN Arrow
            const isNearBottom = (scrollHeight - scrollTop - clientHeight) < 200;
            if (scrollHeight > clientHeight + 100 && !isNearBottom) {
                downBtn.classList.remove('opacity-0', 'translate-y-5', 'hidden'); // ensure not hidden
                downBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                downBtn.classList.remove('opacity-100', 'translate-y-0');
                downBtn.classList.add('opacity-0', 'translate-y-5');
            }
        }
        
        function scrollToResult() {
            const anchor = document.getElementById('resultAnchor');
            if (anchor) {
                anchor.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function scrollToAnalysis() {
            const anchor = document.getElementById('analysisAnchor');
            if (anchor) {
                anchor.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function getUserId(name) {
            return 'user_card_' + name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
        }

        function scrollToUser(name) {
            const id = getUserId(name);
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlight-card');
                setTimeout(() => el.classList.remove('highlight-card'), 2000);
            }
        }

        // Sidebar Toggle Logic
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('absolute', 'w-full', 'h-full', 'left-0', 'top-0');
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('absolute', 'w-full', 'h-full', 'left-0', 'top-0');
            }
        }

        function getDB() {
            const data = localStorage.getItem(DB_KEY);
            return data ? JSON.parse(data) : {};
        }

        function saveDB(data) {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(data));
                updateHistoryList();
                return true; // Success
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    // Strategy: Prune oldest data
                    // Get all keys (dates)
                    const keys = Object.keys(data).sort(); // Ascending: Oldest first
                    
                    // Logic to remove a chunk to avoid too many retries
                    // Try removing 1 item or 10%? Let's remove 1 for safety, or maybe 5 to reduce thrashing.
                    if (keys.length > 0) {
                        const keyToRemove = keys[0];
                        delete data[keyToRemove]; // Remove from memory object
                        
                        console.warn(`LocalStorage Limit Reached. Pruning oldest record: ${keyToRemove}`);
                        
                        // Notify user only once or throttle? 
                        // Since this function is recursive, we might spam toasts.
                        // Let's rely on the final state or check a global flag?
                        // For simplicity, update the status message area instead of Toast if possible, or just a generic Toast.
                        
                        // Retry saving
                        return saveDB(data);
                    } else {
                        // DB is empty but still cant save? (Metadata too huge? Impossible usually)
                        showToast('儲存空間已滿且無法釋放更多空間。');
                        return false;
                    }
                } else {
                    console.error('Storage Error', e);
                    showToast('儲存時發生錯誤');
                    return false;
                }
            }
        }

        // --- TAB LOGIC ---
        function switchTab(tab) {
            activeTab = tab;

            // UI Buttons
            document.querySelectorAll('.header-tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${tab}`);
            if(tabBtn) tabBtn.classList.add('active');
            
            // Sections
            const sourceSec = document.getElementById('sourceSection');
            const overviewSec = document.getElementById('overviewSection');
            const settingsSec = document.getElementById('settingsSection');
            const analysisSec = document.getElementById('analysisTabSection');

            sourceSec.classList.add('hidden');
            overviewSec.classList.add('hidden');
            settingsSec.classList.add('hidden');
            analysisSec.classList.add('hidden');

            // Floating Arrow Buttons Logic (Point 1 Fix)
            const upBtn = document.getElementById('backToResultBtn');
            const downBtn = document.getElementById('goToAnalysisBtn');

            if (tab === 'OVERVIEW') {
                overviewSec.classList.remove('hidden');
                renderData(); 
                // Unhide them so handleScroll can manage them (but handleScroll might hide them initially)
                upBtn.classList.add('hidden'); 
                downBtn.classList.add('hidden');
                setTimeout(handleScroll, 100);
            } else {
                // For all other tabs, FORCE HIDE
                upBtn.classList.add('hidden');
                downBtn.classList.add('hidden');
                
                if (tab === 'ANALYSIS') {
                    analysisSec.classList.remove('hidden');
                    renderTrendAnalysis();
                } else if (tab === 'SOURCE') {
                    sourceSec.classList.remove('hidden');
                    // Only update inputs if config exists in loaded data
                    if (currentDailyData.config && currentDailyData.config.sheetId) {
                         document.getElementById('gsheetId').value = currentDailyData.config.sheetId || '';
                         document.getElementById('colDate').value = currentDailyData.config.cols.date;
                         document.getElementById('colGroup').value = currentDailyData.config.cols.group;
                         document.getElementById('colName').value = currentDailyData.config.cols.name;
                         document.getElementById('colProj').value = currentDailyData.config.cols.proj;
                         document.getElementById('colId').value = currentDailyData.config.cols.id;
                         document.getElementById('colContent').value = currentDailyData.config.cols.content;
                         document.getElementById('colHours').value = currentDailyData.config.cols.hours;
                         document.getElementById('colLink').value = (currentDailyData.config.cols.link !== undefined) ? currentDailyData.config.cols.link : 7;
                    }
                    updateRawPreview();
                } else if (tab === 'SETTINGS') {
                    settingsSec.classList.remove('hidden');
                    renderSettingsTab();
                }
            }
        }

        function updateRawPreview() {
            const ta = document.getElementById('rawJsonPreview');
            const countSpan = document.getElementById('rawDataCount');
            if(currentDailyData.rows && currentDailyData.rows.length > 0) {
                ta.value = JSON.stringify(currentDailyData.rows, null, 2);
                countSpan.innerText = `${currentDailyData.rows.length} 筆資料`;
            } else {
                ta.value = '';
                countSpan.innerText = `0 筆資料`;
            }
        }

        function filterByGroup(groupCode) {
            if (activeFilterGroup === groupCode && groupCode !== 'ALL') {
                activeFilterGroup = 'ALL';
            } else {
                activeFilterGroup = groupCode;
            }

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-group') === activeFilterGroup) {
                    btn.classList.add('active');
                }
            });

            renderData();
        }

        function handleHeaderAction() {
            fetchGoogleSheetData();
        }

        function cleanGroupName(group) {
            if (!group) return '其他';
            group = group.trim();
            if (globalSettings.groupMerges) {
                for (const rule of globalSettings.groupMerges) {
                    if (rule.originals.includes(group)) {
                        return rule.alias;
                    }
                }
            }
            return group;
        }

        // --- NEW: GENERIC CONFIRM MODAL LOGIC (Point 4) ---
        function showConfirmDialog(title, message, onConfirm, isDelete = false) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            
            const btn = document.getElementById('confirmActionBtn');
            const iconContainer = document.getElementById('confirmIconContainer');
            
            // Customize look based on action type
            if (isDelete) {
                btn.className = "px-4 py-2 rounded-lg text-sm font-bold bg-rose-600 text-white hover:bg-rose-700 transition flex-1 shadow-lg shadow-rose-200";
                iconContainer.className = "w-12 h-12 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4";
                iconContainer.innerHTML = '<i class="fa-solid fa-trash-can text-xl"></i>';
            } else {
                btn.className = "px-4 py-2 rounded-lg text-sm font-bold bg-corp-600 text-white hover:bg-corp-700 transition flex-1 shadow-lg shadow-corp-200";
                iconContainer.className = "w-12 h-12 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4";
                iconContainer.innerHTML = '<i class="fa-solid fa-circle-exclamation text-xl"></i>';
            }

            onConfirmAction = onConfirm;
            document.getElementById('confirmDialogOverlay').classList.remove('hidden');
        }

        function closeConfirmDialog() {
            document.getElementById('confirmDialogOverlay').classList.add('hidden');
            onConfirmAction = null;
        }

        function executeConfirm() {
            if (onConfirmAction) {
                onConfirmAction();
            }
            closeConfirmDialog();
        }

        function openReadAllConfirm() {
            showConfirmDialog(
                '確認讀取全部資料', 
                '即將重新讀取 Google Sheet 上的所有歷史資料。若資料量較大可能會需要一點時間，確定要繼續嗎？',
                () => {
                    fetchGoogleSheetData('ALL', true); // Modified: Enable batch write for interactive Read All
                },
                false
            );
        }

        // --- GOOGLE SHEET FETCH LOGIC (Main Driver) ---
        async function fetchGoogleSheetData(autoRefreshRange = null, isInteractiveReadAll = false) {
            const sheetId = document.getElementById('gsheetId').value.trim();
            const pickerDate = document.getElementById('reportDatePicker').value;
            
            const btn = document.getElementById('btnFetchGSheet');
            const statusMsg = document.getElementById('gsheetStatusMsg');
            
            statusMsg.className = 'text-sm font-medium';
            statusMsg.innerHTML = '';

            if (!sheetId) {
                switchTab('SOURCE');
                return showToast('請先設定 Google Sheet ID');
            }
            if (!autoRefreshRange && !pickerDate) return showToast('請選擇日期');

            const cols = {
                date: parseInt(document.getElementById('colDate').value) || 0,
                group: parseInt(document.getElementById('colGroup').value) || 8,
                name: parseInt(document.getElementById('colName').value) || 2,
                proj: parseInt(document.getElementById('colProj').value) || 3,
                id:   parseInt(document.getElementById('colId').value) || 4,
                content: parseInt(document.getElementById('colContent').value) || 5,
                hours:  parseInt(document.getElementById('colHours').value) || 6,
                link:  parseInt(document.getElementById('colLink').value) || 7
            };

            // --- UI Busy State (Only for Manual) ---
            if (!autoRefreshRange) {
                const headerBtn = document.querySelector('[onclick="handleHeaderAction()"]');
                headerBtn.disabled = true;
                btn.disabled = true;
                headerBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span class="hidden md:inline">更新中</span>';
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 讀取中...';
            }

            const updateStatus = (msg, type) => {
                statusMsg.className = type === 'error' ? 'text-rose-600 text-sm font-bold' : 'text-emerald-600 text-sm font-bold';
                statusMsg.innerHTML = msg;
            };

            // Config for Batching
            const BATCH_SIZE = 500;
            let offset = 0;
            let hasMore = true;
            let totalFetched = 0;
            const seenDates = new Set();
            const db = getDB(); // Load existing DB to merge
            
            const dateColIndex = parseInt(document.getElementById('colDate').value) || 0;
            const dateColLetter = getColLetter(dateColIndex);

            // Determine Cutoff Time for Optimization
            let cutoffTime = 0;
            let manualTargetDateStr = null; // For manual mode only

            const today = new Date();
            today.setHours(0,0,0,0);
            
            if (autoRefreshRange === '3') cutoffTime = today.getTime() - (2 * 86400000); 
            else if (autoRefreshRange === '7') cutoffTime = today.getTime() - (6 * 86400000);
            else if (autoRefreshRange === '30') cutoffTime = today.getTime() - (29 * 86400000);
            else if (autoRefreshRange === 'ALL') cutoffTime = 0;
            else if (!autoRefreshRange && pickerDate) {
                // Manual Mode: Setup strict date target
                manualTargetDateStr = pickerDate.trim(); // YYYY-MM-DD
            }

            const strategies = [
                { url: (tq) => `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=${tq}`, name: 'Direct' },
                { url: (tq) => `https://corsproxy.io/?${encodeURIComponent(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=${tq}`)}`, name: 'CorsProxy' },
                { url: (tq) => `https://api.allorigins.win/get?url=${encodeURIComponent(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=${tq}`)}`, name: 'AllOrigins', wrapper: true }
            ];

            // Helper to parse row
            const parseRow = (row) => {
                const c = row.c;
                if (!c) return null;
                const getVal = (i) => (c[i] ? (c[i].f || c[i].v) : '');
                
                const name = String(getVal(cols.name)).trim();
                if (!name) return null;

                const rawGroupName = String(getVal(cols.group)).trim();
                const groupName = rawGroupName; 
                
                let proj = String(getVal(cols.proj)).trim().replace(/【.*?】/g, '').trim();
                let idVal = String(getVal(cols.id)).trim();
                let content = String(getVal(cols.content)).trim();
                let link = String(getVal(cols.link)).trim();
                const hrsVal = getVal(cols.hours);
                const hours = parseFloat(hrsVal) || 0;
                
                return {
                    name, group: groupName, project: proj, issue: idVal, content, hours, link
                };
            };

            // Loop for Batching
            while (hasMore) {
                // Construct Query: Order by Date DESC to get newest first
                const tqParam = encodeURIComponent(`select * order by ${dateColLetter} desc limit ${BATCH_SIZE} offset ${offset}`);
                let successJson = null;
                let fetchSuccess = false;

                // Try Strategies
                for (const strat of strategies) {
                    try {
                        const fetchUrl = strat.url(tqParam);
                        const res = await fetch(fetchUrl);
                        if (!res.ok) throw new Error('Network Error');
                        let text = await res.text();
                        
                        if (strat.wrapper) {
                            const data = JSON.parse(text);
                            text = data.contents;
                        }

                        const start = text.indexOf('{');
                        const end = text.lastIndexOf('}') + 1;
                        if (start > -1 && end > -1) {
                            successJson = JSON.parse(text.substring(start, end));
                            fetchSuccess = true;
                            break; 
                        }
                    } catch(e) {
                        console.warn(`GSheet Strat ${strat.name} failed`, e);
                    }
                }

                if (!fetchSuccess || !successJson || !successJson.table) {
                    if (offset === 0) {
                        updateStatus('讀取失敗：無法存取試算表。', 'error');
                        hasMore = false;
                    } else {
                        updateStatus(`讀取中斷，部分資料已更新 (${totalFetched} 筆)`, 'error');
                        hasMore = false;
                    }
                    break;
                }

                const rows = successJson.table.rows;
                
                if (rows.length === 0) {
                    hasMore = false;
                    break;
                }

                let batchProcessedCount = 0;
                let stopFetching = false;

                // Process Rows
                for (const row of rows) {
                    const c = row.c; 
                    if(!c) continue;
                    const getVal = (i) => (c[i] ? (c[i].f || c[i].v) : '');
                    const rowDateStr = getVal(cols.date);
                    if (!rowDateStr) continue;

                    let keyDateStr = String(rowDateStr).trim();
                    // Normalize slash to dash for parsing
                    const dObj = new Date(keyDateStr.replace(/\//g, '-'));
                    
                    if (isNaN(dObj.getTime())) continue;

                    // Generate standardized YYYY-MM-DD string from object
                    const rowIsoDate = dObj.toISOString().split('T')[0];

                    // --- STOP LOGIC START ---
                    if (manualTargetDateStr) {
                        // MANUAL MODE LOGIC
                        if (rowIsoDate === manualTargetDateStr) {
                            // MATCH: We want this row. Proceed to parse.
                        } else if (dObj < new Date(manualTargetDateStr)) {
                            // OLDER: We went past the target date. STOP.
                            // Since it's sorted DESC, all subsequent rows are older.
                            stopFetching = true;
                            continue; // Skip this row
                        } else {
                            // NEWER: We are looking at a future date (or just newer), skip but continue looking
                            continue;
                        }
                    } else {
                        // AUTO REFRESH MODE LOGIC
                        // Optimization: Stop if date is older than cutoff (only for Auto Refresh modes)
                        if (autoRefreshRange !== 'ALL' && autoRefreshRange && dObj.getTime() < cutoffTime) {
                            stopFetching = true;
                            // continue loop to process remaining buffer? No, sorted DESC means we are done.
                            // break loop logic handles outside for loop.
                        }
                    }
                    // --- STOP LOGIC END ---

                    const parsed = parseRow(row);
                    if(parsed) {
                        // Important: First time we see a date in this session, CLEAR existing data for that day to avoid duplication
                        // Because we might be re-fetching data that changed.
                        if (!seenDates.has(rowIsoDate)) {
                            // OPTIMIZATION: Do not store config for every date
                            db[rowIsoDate] = {
                                rows: []
                            };
                            seenDates.add(rowIsoDate);
                        }
                        db[rowIsoDate].rows.push(parsed);
                        batchProcessedCount++;
                    }
                }

                totalFetched += batchProcessedCount;
                offset += BATCH_SIZE;

                // --- BATCH SAVE & UPDATE UI (Only for Interactive Read All) ---
                if (isInteractiveReadAll) {
                    const saveSuccess = saveDB(db);
                    updateHistoryList();
                    if (!saveSuccess) {
                        hasMore = false; 
                        updateStatus(`儲存空間已滿，已停止讀取。目前更新至 ${totalFetched} 筆`, 'error');
                        break;
                    }
                    updateStatus(`讀取中... 已更新 ${totalFetched} 筆 (由新到舊)`, 'success');
                    
                    // Refresh view if needed
                    if (currentReportDate && seenDates.has(currentReportDate)) {
                        loadReportByDate(currentReportDate, true);
                    }
                }

                // Check stop conditions
                // If rows < BATCH_SIZE, we reached end of sheet naturally.
                // If stopFetching flag is true, we reached our cutoff/target.
                if (rows.length < BATCH_SIZE || stopFetching) {
                    hasMore = false;
                } else {
                    // Small delay to prevent rate limiting
                    await new Promise(r => setTimeout(r, 50));
                }
            }
            
            // --- FINAL SAVE & UPDATE UI ---
            let saveSuccess = true;
            if (!isInteractiveReadAll) {
                // For Manual and standard Auto Refresh, we save ONCE at the end.
                saveSuccess = saveDB(db);
            }
            
            if (!saveSuccess) {
                updateStatus(`儲存空間已滿，部分舊資料可能已清理以騰出空間。`, 'error');
            } else {
                if (!autoRefreshRange) {
                    // Manual Mode Finalization
                    const headerBtn = document.querySelector('[onclick="handleHeaderAction()"]');
                    headerBtn.disabled = false;
                    btn.disabled = false;
                    headerBtn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> <span class="hidden md:inline">更新</span>';
                    btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i> 讀取當日資料';
                    
                    // Manual mode completion behavior
                    if (currentDailyData.rows.length === 0 && !pickerDate) {
                         // Try to load latest available
                         const availableDates = Object.keys(db).sort().reverse();
                         if (availableDates.length > 0) loadReportByDate(availableDates[0]);
                    } else if (pickerDate) {
                         // Ensure the picked date is loaded if available
                         if (db[pickerDate]) {
                             loadReportByDate(pickerDate);
                             updateStatus(`更新完成：${pickerDate} (共 ${totalFetched} 筆)`, 'success');
                         } else {
                             // If we fetched 0 records for the target date
                             if (totalFetched === 0) {
                                 // Maybe it wasn't found in the top rows?
                                 // But logic says we scan until we find older.
                                 // So it implies no data for that date exists (or sort order is wrong in sheet).
                                 updateStatus(`查無 ${pickerDate} 的資料 (或資料過舊)`, 'error');
                             } else {
                                 showToast('所選日期尚無資料');
                             }
                         }
                    }
                    
                    if (activeTab !== 'OVERVIEW') {
                        switchTab('OVERVIEW');
                    }
                } else {
                    // Auto Refresh Finalization (and Interactive Read All Final Status)
                    const rangeLabel = autoRefreshRange === 'ALL' ? '全部' : '近'+autoRefreshRange+'天';
                    const msg = `刷新完成 (範圍: ${rangeLabel}, 共 ${totalFetched} 筆)`;
                    updateStatus(msg, 'success');
                    showToast(msg);
                    
                    // Refresh current view if relevant
                    updateHistoryList();
                    if (currentReportDate && db[currentReportDate]) {
                        loadReportByDate(currentReportDate, true); // true = prevent tab switch, just refresh data
                    }
                    if (activeTab === 'ANALYSIS') renderTrendAnalysis();
                }
            }
            
            updateRawPreview();
        }

        // --- RENDER LOGIC ---
        function cleanAuthorName(name) {
            if (!name) return 'Unknown';
            
            // 1. 先取後五碼 (兼容舊規則，處理過長的前綴)
            let shortName = name.slice(-5);
            
            // 2. 再去除開頭的英文字母 (針對 S網頁陳葳 這類情況)
            return shortName.replace(/^[a-zA-Z]+/, '');
        }
        
        function renderData() {
            const rawRows = currentDailyData.rows || [];
            
            const analysisSection = document.getElementById('analysisSection');
            const resultSection = document.getElementById('resultSection');
            const emptyState = document.getElementById('emptyState');

            if (rawRows.length === 0) {
                analysisSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.getElementById('headerTotalManHours').innerText = "0 人 / 0.0hr";
                document.getElementById('groupFilterButtons').innerHTML = '';
                return;
            }

            analysisSection.classList.remove('hidden');
            resultSection.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const uniqueGroups = Array.from(new Set(rawRows.map(r => cleanGroupName(r.group)))).sort();
            
            if (activeFilterGroup !== 'ALL' && !uniqueGroups.includes(activeFilterGroup)) {
                activeFilterGroup = 'ALL';
            }
            
            renderDynamicFilterButtons(uniqueGroups);

            // New: Toggle QA Link Button
            const btnQa = document.getElementById('btnQaLink');
            if (btnQa) {
                if (activeFilterGroup === '品檢') {
                    btnQa.classList.remove('hidden');
                    btnQa.classList.add('flex');
                } else {
                    btnQa.classList.add('hidden');
                    btnQa.classList.remove('flex');
                }
            }

            const userMap = {};
            let totalHoursGlobal = 0;

            rawRows.forEach(row => {
                const dynamicGroup = cleanGroupName(row.group);

                if (!userMap[row.name]) {
                    userMap[row.name] = { 
                        name: row.name, 
                        group: dynamicGroup || '其他', 
                        originalGroup: row.group || '其他', 
                        totalHours: 0, 
                        tasks: [] 
                    };
                }
                
                userMap[row.name].totalHours += row.hours;
                userMap[row.name].tasks.push(row);
                totalHoursGlobal += row.hours;
            });

            const userList = Object.values(userMap);
            
            let filteredUserList = userList;
            if (activeFilterGroup !== 'ALL') {
                filteredUserList = userList.filter(u => u.group === activeFilterGroup);
            }

            const userCount = userList.length; 

            const statsText = `${userCount}人 / ${totalHoursGlobal.toFixed(1)}hr`;
            document.getElementById('headerTotalManHours').innerText = statsText;

            let filteredHours = 0;
            filteredUserList.forEach(u => filteredHours += u.totalHours);
            const filteredStatsText = `${filteredUserList.length}人 / ${filteredHours.toFixed(1)}hr`;
            document.getElementById('widgetTotalManHours').innerText = filteredStatsText;

            filteredUserList.sort((a, b) => {
                if (a.group !== b.group) return a.group.localeCompare(b.group, 'zh-Hant');
                if (a.originalGroup !== b.originalGroup) return a.originalGroup.localeCompare(b.originalGroup, 'zh-Hant');
                return b.totalHours - a.totalHours;
            });

            renderDetailList(filteredUserList);
            renderDashboardWidgets(filteredUserList);
            renderProjectStats(filteredUserList);
        }

        function renderDynamicFilterButtons(groups) {
            const container = document.getElementById('groupFilterButtons');
            if (!container) return;

            let html = `
                <button class="filter-btn ${activeFilterGroup === 'ALL' ? 'active' : ''}" 
                        data-group="ALL" 
                        onclick="filterByGroup('ALL')">
                    全部
                </button>
            `;

            groups.forEach(group => {
                if (!group) return; 
                const isActive = (activeFilterGroup === group);
                html += `
                    <button class="filter-btn ${isActive ? 'active' : ''}" 
                            data-group="${group}" 
                            onclick="filterByGroup('${group}')">
                        ${group}
                    </button>
                `;
            });

            container.innerHTML = html;
        }

        function renderDashboardWidgets(userList) {
            const container = document.getElementById('hoursGridContainer');
            container.innerHTML = '';
            
            const sorted = [...userList].sort((a,b) => b.totalHours - a.totalHours);

            let rows = '';
            sorted.forEach(u => {
                let barColor = 'bg-emerald-500';
                let hoursClass = 'text-emerald-700';
                if (u.totalHours < 8) { barColor = 'bg-amber-400'; hoursClass = 'text-amber-700'; }
                else if (u.totalHours > 10) { barColor = 'bg-rose-500'; hoursClass = 'text-rose-700'; }
                
                let width = Math.min((u.totalHours / 12) * 100, 100);
                
                const shortName = cleanAuthorName(u.name);
                // 修改：取消顯示副組名，以確保名字能完整顯示
                const displayLabel = shortName;
                const safeName = u.name.replace(/'/g, "\\'");

                rows += `
                    <div onclick="scrollToUser('${safeName}')" class="cursor-pointer flex items-center gap-3 p-2 bg-slate-50 rounded-lg hover:bg-slate-100 transition" title="點擊跳轉到工作項目">
                        <div class="font-bold text-sm text-slate-700 truncate w-32 shrink-0" title="${u.name}">${displayLabel}</div>
                        <div class="flex-1 bg-slate-200 rounded-full h-2 overflow-hidden">
                             <div class="${barColor} h-2 rounded-full" style="width: ${width}%"></div>
                        </div>
                        <div class="font-mono text-sm font-bold ${hoursClass} w-12 text-right">${u.totalHours.toFixed(1)}</div>
                    </div>
                `;
            });
            container.innerHTML = rows;
        }

        function handleMergeButtonClick() {
            const btn = document.getElementById('btnMergeAction');
            const span = btn.querySelector('span');
            const cancelBtn = document.getElementById('btnCancelMerge');
            const thCheckbox = document.getElementById('thCheckbox');
            const hint = document.getElementById('mergeHint');

            if (!isMergeMode) {
                isMergeMode = true;
                span.innerText = "合併選取項目";
                cancelBtn.classList.remove('hidden');
                thCheckbox.classList.remove('hidden');
                hint.classList.remove('hidden');
                renderData();
            } else {
                openMergeDialog();
            }
        }

        function cancelMergeMode() {
            const btn = document.getElementById('btnMergeAction');
            const span = btn.querySelector('span');
            const cancelBtn = document.getElementById('btnCancelMerge');
            const thCheckbox = document.getElementById('thCheckbox');
            const hint = document.getElementById('mergeHint');

            isMergeMode = false;
            span.innerText = "合併設定";
            cancelBtn.classList.add('hidden');
            thCheckbox.classList.add('hidden');
            hint.classList.add('hidden');
            renderData();
        }

        function openMergeDialog() {
            const checkboxes = document.querySelectorAll('.proj-checkbox:checked');
            if (checkboxes.length < 2) {
                return showToast('請至少勾選兩個專案進行合併');
            }

            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            const defaultName = selectedNames[0];

            document.getElementById('mergeNameInput').value = defaultName;
            const listEl = document.getElementById('mergeListPreview');
            listEl.innerHTML = selectedNames.map(name => `<li>${name}</li>`).join('');

            document.getElementById('mergeDialogOverlay').classList.remove('hidden');
            document.getElementById('mergeNameInput').focus();
        }

        function closeMergeDialog() {
            document.getElementById('mergeDialogOverlay').classList.add('hidden');
        }

        function confirmMerge() {
            const newName = document.getElementById('mergeNameInput').value;
            if (!newName || !newName.trim()) {
                showToast('請輸入合併後的名稱');
                return;
            }

            const checkboxes = document.querySelectorAll('.proj-checkbox:checked');
            const selectedNames = Array.from(checkboxes).map(cb => cb.value);

            let actualOriginals = [];
            
            selectedNames.forEach(name => {
                const existingRuleIndex = globalSettings.projectMerges.findIndex(r => r.alias === name);
                
                if (existingRuleIndex > -1) {
                    actualOriginals.push(...globalSettings.projectMerges[existingRuleIndex].originals);
                    globalSettings.projectMerges.splice(existingRuleIndex, 1);
                } else {
                    actualOriginals.push(name);
                }
            });

            globalSettings.projectMerges.push({
                alias: newName.trim(),
                originals: actualOriginals
            });

            saveGlobalSettings();
            
            closeMergeDialog();
            cancelMergeMode(); 
            showToast('合併成功！可至「控制台」管理規則');
        }

        function renderProjectStats(userList) {
            const canvas = document.getElementById('projectPieChart');
            if (!canvas || canvas.offsetParent === null) {
                if (projectChartInstance) {
                    projectChartInstance.destroy();
                    projectChartInstance = null;
                }
                return; 
            }

            let allTasks = [];
            userList.forEach(u => allTasks.push(...u.tasks));
            
            if (allTasks.length === 0) {
                 document.getElementById('projectTableBody').innerHTML = '';
                 if (projectChartInstance) {
                      projectChartInstance.destroy();
                      projectChartInstance = null;
                 }
                 return;
            }

            const counts = {};
            let total = 0;

            allTasks.forEach(t => {
                let p = t.project || '未分類';
                const mergeRule = globalSettings.projectMerges.find(rule => rule.originals.includes(p));
                if (mergeRule) {
                    p = mergeRule.alias; 
                }

                counts[p] = (counts[p] || 0) + t.hours;
                total += t.hours;
            });

            const dataArr = Object.keys(counts).map(k => ({
                name: k,
                hours: counts[k],
                percent: (counts[k] / total * 100).toFixed(1)
            })).sort((a, b) => b.hours - a.hours);

            const tbody = document.getElementById('projectTableBody');
            const thCheckbox = document.getElementById('thCheckbox');
            if (isMergeMode) thCheckbox.classList.remove('hidden');
            else thCheckbox.classList.add('hidden');

            tbody.innerHTML = dataArr.map((d, i) => {
                const safeName = d.name.replace(/"/g, '&quot;');
                return `
                <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 group">
                    <td class="px-3 py-2 text-center ${isMergeMode ? '' : 'hidden'}">
                        <input type="checkbox" class="proj-checkbox rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer" value="${safeName}">
                    </td>
                    <td class="px-3 py-2 font-bold text-slate-700 flex items-center">
                        <span class="inline-block w-2.5 h-2.5 rounded-full mr-2" style="background-color: ${getColor(i)}"></span>
                        <span class="truncate max-w-[120px]" title="${d.name}">${d.name}</span>
                    </td>
                    <td class="px-3 py-2 text-right font-mono">${d.hours.toFixed(1)}</td>
                    <td class="px-3 py-2 text-right font-mono text-slate-400">${d.percent}%</td>
                </tr>
            `}).join('');

            const ctx = document.getElementById('projectPieChart').getContext('2d');
            
            if (projectChartInstance) {
                projectChartInstance.destroy();
                projectChartInstance = null; 
            }

            projectChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataArr.map(d => d.name),
                    datasets: [{
                        data: dataArr.map(d => d.hours),
                        backgroundColor: dataArr.map((_, i) => getColor(i)),
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    let value = context.parsed.toFixed(1);
                                    let percentage = (context.parsed / total * 100).toFixed(1) + '%';
                                    return label + value + 'hr (' + percentage + ')';
                                }
                            }
                        }
                    },
                    cutout: '65%',
                    layout: { padding: 10 }
                }
            });
        }

        function toggleAllProjectCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.proj-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function addGroupRule() {
            const aliasInput = document.getElementById('newGroupAlias');
            const sourceInput = document.getElementById('newGroupSources');
            
            const alias = aliasInput.value.trim();
            const sourcesRaw = sourceInput.value.trim();

            if (!alias || !sourcesRaw) {
                return showToast('請填寫完整資訊');
            }

            const sources = sourcesRaw.split(/[,\s，]+/).filter(s => s.trim() !== '');
            if (sources.length === 0) return showToast('請輸入至少一個原始名稱');

            globalSettings.groupMerges.unshift({
                alias: alias,
                originals: sources
            });

            saveGlobalSettings();
            
            aliasInput.value = '';
            sourceInput.value = '';
            showToast('來源規則已新增');
        }

        function deleteGroupRule(index) {
            ruleToDeleteIndex = index;
            deleteType = 'group';
            showConfirmDialog(
                '移除規則',
                '確定要刪除此來源合併規則嗎？',
                () => {
                    globalSettings.groupMerges.splice(index, 1);
                    saveGlobalSettings();
                    renderSettingsTab();
                    showToast('已刪除規則');
                },
                true
            );
        }

        function openEditGroupRule(index) {
            ruleToEditGroupIndex = index;
            const rule = globalSettings.groupMerges[index];
            if (!rule) return;

            const aliasInput = document.getElementById('editGroupAliasInput');
            const sourcesInput = document.getElementById('editGroupSourcesInput');
            
            aliasInput.value = rule.alias;
            sourcesInput.value = rule.originals.join(', ');
            
            document.getElementById('editGroupDialogOverlay').classList.remove('hidden');
            aliasInput.focus();
        }

        function closeEditGroupDialog() {
            document.getElementById('editGroupDialogOverlay').classList.add('hidden');
            ruleToEditGroupIndex = -1;
        }

        function saveEditedGroupRule() {
            if (ruleToEditGroupIndex === -1) return;
            
            const aliasInput = document.getElementById('editGroupAliasInput');
            const sourcesInput = document.getElementById('editGroupSourcesInput');
            
            const newAlias = aliasInput.value.trim();
            const newSourcesRaw = sourcesInput.value.trim();

            if (!newAlias || !newSourcesRaw) {
                return showToast('請填寫完整資訊');
            }

            const newSources = newSourcesRaw.split(/[,\s，]+/).filter(s => s.trim() !== '');
            if (newSources.length === 0) return showToast('請輸入至少一個原始名稱');

            globalSettings.groupMerges[ruleToEditGroupIndex] = {
                alias: newAlias,
                originals: newSources
            };
            saveGlobalSettings();
            
            closeEditGroupDialog();
            renderData();
            showToast('來源規則已更新');
        }

        function deleteProjectRule(index) {
            ruleToDeleteIndex = index;
            deleteType = 'project';
            showConfirmDialog(
                '移除規則',
                '確定要刪除此專案合併規則嗎？',
                () => {
                    globalSettings.projectMerges.splice(index, 1);
                    saveGlobalSettings();
                    renderSettingsTab();
                    showToast('已刪除規則');
                },
                true
            );
        }

        function openEditProjectRule(index) {
            ruleToEditIndex = index;
            const rule = globalSettings.projectMerges[index];
            if (!rule) return;

            const input = document.getElementById('editAliasInput');
            input.value = rule.alias;
            
            document.getElementById('editDialogOverlay').classList.remove('hidden');
            input.focus();
        }

        function closeEditDialog() {
            document.getElementById('editDialogOverlay').classList.add('hidden');
            ruleToEditIndex = -1;
        }

        function saveEditedProjectRule() {
            if (ruleToEditIndex === -1) return;
            
            const input = document.getElementById('editAliasInput');
            const newAlias = input.value.trim();
            
            if (!newAlias) {
                return showToast('請輸入名稱');
            }

            globalSettings.projectMerges[ruleToEditIndex].alias = newAlias;
            saveGlobalSettings();
            
            closeEditDialog();
            renderData(); 
            showToast('名稱已更新');
        }

        // Renamed/Refactored legacy function to use new confirm flow inside delete buttons above, but kept structure if needed
        function executeDeleteRule() {
            // This is now handled by the callback in showConfirmDialog
        }

        function renderSettingsTab() {
            const projContainer = document.getElementById('mergeRulesContainer');
            const noProjMsg = document.getElementById('noRulesMsg');
            
            if (globalSettings.projectMerges.length === 0) {
                projContainer.innerHTML = '';
                noProjMsg.classList.remove('hidden');
            } else {
                noProjMsg.classList.add('hidden');
                projContainer.innerHTML = globalSettings.projectMerges.map((rule, index) => `
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-slate-700">${rule.alias}</span>
                                <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">專案合併</span>
                            </div>
                            <div class="text-xs text-slate-400 leading-relaxed break-all">
                                包含: ${rule.originals.join(', ')}
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button onclick="openEditProjectRule(${index})" class="text-slate-400 hover:text-indigo-600 p-2 transition" title="編輯名稱">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button onclick="deleteProjectRule(${index})" class="text-slate-400 hover:text-rose-500 p-2 transition" title="刪除規則">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            const groupContainer = document.getElementById('groupRulesContainer');
            groupContainer.innerHTML = globalSettings.groupMerges.map((rule, index) => `
                <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex-1 overflow-hidden">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-emerald-700">${rule.alias}</span>
                            <span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full">組別</span>
                        </div>
                        <div class="text-xs text-slate-400 truncate" title="${rule.originals.join(', ')}">
                            ${rule.originals.join(', ')}
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button onclick="openEditGroupRule(${index})" class="text-slate-300 hover:text-emerald-600 p-2 transition" title="編輯規則">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button onclick="deleteGroupRule(${index})" class="text-slate-300 hover:text-rose-500 p-2 transition" title="刪除規則">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderDetailList(userList) {
            const container = document.getElementById('detailView');
            container.innerHTML = '';
            
            if (userList.length === 0) {
                 container.innerHTML = `<div class="p-4 text-center text-slate-400 border border-slate-200 rounded-lg bg-white/50"><i class="fa-solid fa-filter text-lg mr-2"></i> 目前篩選條件下無匹配資料。</div>`;
                 document.getElementById('analysisSection').classList.add('hidden');
                 return;
            }
            
            document.getElementById('analysisSection').classList.remove('hidden');

            userList.forEach(u => {
                let hoursColor = 'bg-emerald-100 text-emerald-800';
                if (u.totalHours < 8) hoursColor = 'bg-amber-100 text-amber-800';
                if (u.totalHours > 10) hoursColor = 'bg-rose-100 text-rose-800';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col md:flex-row overflow-hidden mb-2';
                
                card.id = getUserId(u.name);

                const shortName = cleanAuthorName(u.name);
                
                let tasksHtml = u.tasks.map(t => {
                    let linkHtml = '';
                    if (t.link && t.link.startsWith('http')) {
                         linkHtml = `
                            <div class="mt-2 text-right">
                                <a href="${t.link}" target="_blank" class="inline-flex items-center gap-1 text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 hover:text-indigo-800 transition font-bold border border-indigo-100">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i> 開啟連結
                                </a>
                            </div>
                          `;
                    }

                    return `
                    <div class="border-b border-slate-100 last:border-0">
                        <button class="accordion-btn w-full text-left p-2 flex items-center justify-between hover:bg-slate-50 transition group focus:outline-none" onclick="toggleTask(this)" aria-expanded="false">
                            <div class="flex flex-wrap items-center gap-x-2 gap-y-1 pr-4">
                                <span class="text-[10px] text-slate-500 px-1.5 py-0.5 bg-slate-100 rounded border border-slate-100" title="專案">${t.project}</span>
                                <span class="text-sm font-bold text-slate-700 font-mono" title="議題ID">${t.issue}</span>
                                <span class="text-xs font-bold text-corp-600 font-mono ml-auto md:ml-2" title="時數">: ${t.hours}hr</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-xs accordion-icon group-hover:text-corp-600"></i>
                        </button>
                        <div class="accordion-content bg-slate-50/50">
                            <div class="text-xs leading-relaxed pl-1 pt-2 border-t border-slate-100 border-dashed mx-3 mb-2 text-slate-600 whitespace-pre-line">
                                ${formatContent(t.content)}
                            </div>
                            <div class="px-3 pb-2">
                                ${linkHtml}
                            </div>
                        </div>
                    </div>
                `}).join('');

                card.innerHTML = `
                    <div onclick="toggleAllTasks(this)" class="cursor-pointer hover:bg-slate-100 transition p-2 md:w-32 bg-slate-50 md:border-r border-b md:border-b-0 border-slate-200 flex flex-row md:flex-col items-center justify-between md:justify-center gap-1 shrink-0" title="點擊展開/收合所有項目">
                        <div class="flex flex-col items-center">
                            <div class="text-[10px] text-slate-400 font-bold mb-0.5">${u.originalGroup}</div>
                            <div class="font-bold text-sm text-slate-800 text-center leading-tight whitespace-nowrap truncate w-full px-1" title="${u.name}">
                                ${shortName}
                            </div>
                        </div>
                        <div class="px-2 py-0.5 rounded-full text-[10px] font-bold ${hoursColor} mt-1">${u.totalHours.toFixed(1)}h</div>
                    </div>
                    <div class="flex-1 bg-white flex flex-col">${tasksHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleAllTasks(headerEl) {
            const card = headerEl.parentElement;
            const buttons = card.querySelectorAll('.accordion-btn');
            const contents = card.querySelectorAll('.accordion-content');
            
            const allExpanded = Array.from(buttons).every(btn => btn.getAttribute('aria-expanded') === 'true');
            const newState = !allExpanded;

            buttons.forEach(btn => {
                btn.setAttribute('aria-expanded', newState);
                const icon = btn.querySelector('.accordion-icon');
                if (icon) {
                    if (newState) icon.style.transform = 'rotate(180deg)';
                    else icon.style.transform = 'rotate(0deg)';
                }
            });
            
            contents.forEach(content => {
                if (newState) {
                    content.classList.add('expanded', 'p-3', 'pt-0');
                } else {
                    content.classList.remove('expanded', 'p-3', 'pt-0');
                }
            });
        }

        function formatContent(text) {
             if (!text) return '(無內容)';
             return text.replace(/(測試內容|工作事項|問題回報)/g, '<span class="font-bold text-slate-800">$1</span>');
        }

        function toggleTask(btn) {
            const container = btn.parentElement;
            const content = container.querySelector('.accordion-content');
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', !isExpanded);
            if (!isExpanded) {
                content.classList.add('expanded', 'p-3', 'pt-0');
            } else {
                content.classList.remove('expanded', 'p-3', 'pt-0');
            }
        }

        // --- TREND ANALYSIS LOGIC (NEW) ---
        function setAnalysisMode(mode) {
            analysisMode = mode;
            activeTrendFilter = null; 
            
            const btnProject = document.getElementById('btnModeProject');
            const btnPerson = document.getElementById('btnModePerson');
            const btnGroup = document.getElementById('btnModeGroup');
            
            const btnResetPerson = document.getElementById('btnResetPerson');
            const btnResetProject = document.getElementById('btnResetProject');
            
            const activeClass = ['bg-white', 'text-corp-600', 'shadow-sm'];
            const inactiveClass = ['text-slate-500', 'hover:text-slate-700'];
            
            [btnProject, btnPerson, btnGroup].forEach(btn => {
                btn.classList.remove(...activeClass);
                btn.classList.add(...inactiveClass);
            });

            const activeBtn = mode === 'PROJECT' ? btnProject : (mode === 'PERSON' ? btnPerson : btnGroup);
            activeBtn.classList.remove(...inactiveClass);
            activeBtn.classList.add(...activeClass);

            const entityArea = document.getElementById('entitySelectionArea');
            const chartHint = document.getElementById('chartLegendHint');
            const title = document.getElementById('entitySelectionTitle');
            
            btnResetPerson.classList.add('hidden');
            btnResetProject.classList.add('hidden');

            if (mode === 'PERSON') {
                entityArea.classList.remove('hidden');
                chartHint.classList.add('hidden'); 
                title.innerHTML = '<i class="fa-solid fa-user-plus"></i> 點擊加入比對 (依組別分類)';
                shouldSelectAllPersons = true; 
            } else if (mode === 'PROJECT') {
                entityArea.classList.remove('hidden');
                chartHint.classList.add('hidden'); 
                title.innerHTML = '<i class="fa-solid fa-plus-circle"></i> 點擊加入比對 (專案清單)';
                shouldSelectAllProjects = true;
            } else {
                entityArea.classList.add('hidden');
                chartHint.classList.remove('hidden');
            }

            if (mode === 'PERSON') {
                selectedPersons.clear();
            } else if (mode === 'PROJECT') {
                selectedProjects.clear();
            }

            renderTrendAnalysis();
        }

        function clearTrendFilter() {
            activeTrendFilter = null;
            renderTrendAnalysis();
        }

        function resetPersonSelection() {
            shouldSelectAllPersons = true;
            selectedPersons.clear();
            renderTrendAnalysis();
        }

        function resetProjectSelection() {
            shouldSelectAllProjects = true;
            selectedProjects.clear();
            renderTrendAnalysis();
        }

        function toggleProjectSelection(name) {
            if (analysisMode === 'PROJECT') {
                // FIXED: Set flag to false on manual toggle to respect user selection
                shouldSelectAllProjects = false;
                
                const isAllSelected = (selectedProjects.size === currentTotalEntitiesCount && currentTotalEntitiesCount > 0);
                
                if (isAllSelected) {
                    selectedProjects.clear();
                    selectedProjects.add(name);
                } else {
                    if (selectedProjects.size === 1 && selectedProjects.has(name)) {
                        resetProjectSelection();
                        return; 
                    }
                    if (selectedProjects.has(name)) {
                        selectedProjects.delete(name);
                    } else {
                        selectedProjects.add(name);
                    }
                }
                setTimeout(() => renderTrendAnalysis(), 0);
            }
        }

        function togglePersonSelection(name) {
            if (analysisMode === 'PERSON') {
                // FIXED: Set flag to false on manual toggle
                shouldSelectAllPersons = false; 
                
                const isAllSelected = (selectedPersons.size === currentTotalEntitiesCount && currentTotalEntitiesCount > 0);
                
                if (isAllSelected) {
                    selectedPersons.clear();
                    selectedPersons.add(name);
                } else {
                    if (selectedPersons.size === 1 && selectedPersons.has(name)) {
                        resetPersonSelection();
                        return; 
                    }
                    if (selectedPersons.has(name)) {
                        selectedPersons.delete(name);
                    } else {
                        selectedPersons.add(name);
                    }
                }
                setTimeout(() => renderTrendAnalysis(), 0);
            }
        }

        function renderTrendAnalysis() {
            const hintBox = document.getElementById('trendFilterHint');
            const hintText = document.getElementById('trendFilterText');
            
            if (analysisMode === 'GROUP' && activeTrendFilter) {
                hintBox.classList.remove('hidden');
                hintText.innerText = `目前聚焦：${activeTrendFilter}`;
            } else {
                hintBox.classList.add('hidden');
            }

            const db = getDB();
            const daysToAnalyze = parseInt(document.getElementById('analysisDays').value) || 7;
            
            // --- NEW: MONTHLY AGGREGATION LOGIC (Point 2) ---
            const isMonthlyMode = daysToAnalyze > 30; // Threshold for switching to monthly view
            
            const today = new Date();
            const labels = []; // X-axis labels (Dates or Months)
            
            if (isMonthlyMode) {
                // Generate last N months labels (YYYY-MM)
                // daysToAnalyze = 90 -> approx 3 months, 180 -> 6, 365 -> 12
                const monthsCount = Math.round(daysToAnalyze / 30);
                for(let i=monthsCount-1; i>=0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    labels.push(`${year}-${month}`);
                }
            } else {
                // Generate daily labels
                for(let i=daysToAnalyze-1; i>=0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    labels.push(d.toISOString().split('T')[0]);
                }
            }

            const aggregated = {}; // { Label: { Entity: Hours } }
            const allEntities = new Set(); 
            const entityTotals = {}; 
            const personGroups = {}; 
            const rowStats = {}; // For Avg calculation

            // Initialize aggregation buckets
            labels.forEach(lbl => {
                aggregated[lbl] = {};
                rowStats[lbl] = { totalHours: 0, uniqueAuthors: new Set() };
            });

            // Iterate over all DB data keys (YYYY-MM-DD)
            Object.keys(db).forEach(dateKey => {
                if (!db[dateKey] || !db[dateKey].rows) return;
                
                let targetLabel = null;
                
                if (isMonthlyMode) {
                    // Check if this date belongs to one of our target months
                    const dKeyMonth = dateKey.substring(0, 7); // "YYYY-MM"
                    if (labels.includes(dKeyMonth)) {
                        targetLabel = dKeyMonth;
                    }
                } else {
                    // Exact match for daily mode
                    if (labels.includes(dateKey)) {
                        targetLabel = dateKey;
                    }
                }

                if (targetLabel) {
                    db[dateKey].rows.forEach(row => {
                        let key = '';
                        let isRelevantForGroupStats = false;

                        if (analysisMode === 'PROJECT') {
                            key = row.project || '未分類';
                            const mergeRule = globalSettings.projectMerges.find(rule => rule.originals.includes(key));
                            if (mergeRule) key = mergeRule.alias;
                        } else if (analysisMode === 'PERSON') {
                            key = cleanAuthorName(row.name);
                            personGroups[key] = cleanGroupName(row.group); 
                        } else if (analysisMode === 'GROUP') {
                            key = cleanGroupName(row.group);
                            if (!activeTrendFilter || key === activeTrendFilter) {
                                isRelevantForGroupStats = true;
                            }
                        }
                        
                        const val = row.hours;
                        
                        // Accumulate
                        aggregated[targetLabel][key] = (aggregated[targetLabel][key] || 0) + val;
                        
                        allEntities.add(key);
                        entityTotals[key] = (entityTotals[key] || 0) + val;

                        if (analysisMode === 'GROUP' && isRelevantForGroupStats) {
                            rowStats[targetLabel].totalHours += val;
                            rowStats[targetLabel].uniqueAuthors.add(row.name);
                        }
                    });
                }
            });

            let entitiesArr = Array.from(allEntities);
            currentTotalEntitiesCount = entitiesArr.length;
            entitiesArr.sort((a,b) => entityTotals[b] - entityTotals[a]);

            if (analysisMode === 'PERSON' || analysisMode === 'PROJECT') {
                const isProjectMode = (analysisMode === 'PROJECT');
                const selectedSet = isProjectMode ? selectedProjects : selectedPersons;
                const shouldSelectAll = isProjectMode ? shouldSelectAllProjects : shouldSelectAllPersons;
                const btnReset = isProjectMode ? document.getElementById('btnResetProject') : document.getElementById('btnResetPerson');

                // FIXED: Don't disable flag here. Rely on toggle function to disable it.
                // This ensures "All" selection persists across date range changes.
                if (shouldSelectAll && entitiesArr.length > 0) {
                    entitiesArr.forEach(p => selectedSet.add(p));
                }

                if (selectedSet.size < currentTotalEntitiesCount && selectedSet.size > 0) {
                    btnReset.classList.remove('hidden');
                } else {
                    btnReset.classList.add('hidden');
                }

                const unselectedContainer = document.getElementById('unselectedEntityContainer');
                unselectedContainer.innerHTML = '';

                const unselectedByGroup = {};
                entitiesArr.forEach(p => {
                    if (!selectedSet.has(p)) {
                        let grp = '其他';
                        if (isProjectMode) {
                            grp = '專案清單'; 
                        } else {
                            grp = personGroups[p] || '其他';
                        }
                        
                        if (!unselectedByGroup[grp]) unselectedByGroup[grp] = [];
                        unselectedByGroup[grp].push(p);
                    }
                });

                const sortedGroups = Object.keys(unselectedByGroup).sort();
                if (sortedGroups.length === 0) {
                    unselectedContainer.innerHTML = '<div class="text-xs text-slate-400 italic">所有項目已在圖表中</div>';
                } else {
                    sortedGroups.forEach(grp => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = "mb-1";
                        
                        const groupTitle = document.createElement('h5');
                        groupTitle.className = "text-[10px] font-bold text-slate-400 mb-1 ml-1";
                        groupTitle.innerText = grp;
                        groupDiv.appendChild(groupTitle);

                        const btnContainer = document.createElement('div');
                        btnContainer.className = "flex flex-wrap gap-2";
                        
                        unselectedByGroup[grp].forEach(p => {
                            const btn = document.createElement('button');
                            btn.className = "text-[10px] font-medium px-2 py-1 rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 hover:text-corp-600 transition flex items-center gap-1 shadow-sm";
                            btn.innerHTML = `<i class="fa-solid fa-plus text-slate-300"></i> ${p}`;
                            btn.onclick = () => isProjectMode ? toggleProjectSelection(p) : togglePersonSelection(p);
                            btnContainer.appendChild(btn);
                        });
                        
                        groupDiv.appendChild(btnContainer);
                        unselectedContainer.appendChild(groupDiv);
                    });
                }

                entitiesArr = Array.from(selectedSet);
                entitiesArr.sort((a,b) => entityTotals[b] - entityTotals[a]);
            } 
            else {
                if (activeTrendFilter) {
                    entitiesArr = entitiesArr.filter(e => e === activeTrendFilter);
                }
            }
            
            let isStacked = false;
            if (analysisMode === 'GROUP') {
                isStacked = true;
            } else if (analysisMode === 'PROJECT') {
                const allSelected = (selectedProjects.size === currentTotalEntitiesCount && currentTotalEntitiesCount > 0);
                isStacked = allSelected;
            }
            
            const datasets = entitiesArr.map((entity, i) => {
                return {
                    label: entity,
                    data: labels.map(lbl => aggregated[lbl][entity] || 0), // Use labels array
                    backgroundColor: getColor(i),
                    stack: isStacked ? 'Stack 0' : undefined, 
                };
            });

            const ctxEl = document.getElementById('trendChart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            if (trendChartInstance) {
                trendChartInstance.destroy();
                trendChartInstance = null; 
            }

            trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, activeElements, chart) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].datasetIndex;
                            const label = chart.data.datasets[datasetIndex].label;
                            
                            if (analysisMode === 'PERSON') {
                                togglePersonSelection(label);
                            } else if (analysisMode === 'PROJECT') {
                                toggleProjectSelection(label);
                            } else {
                                if (activeTrendFilter === label) {
                                     activeTrendFilter = null;
                                } else {
                                     activeTrendFilter = label;
                                }
                                setTimeout(() => renderTrendAnalysis(), 0);
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: isStacked,
                            title: { display: isMonthlyMode, text: isMonthlyMode ? '月份' : '日期' }
                        },
                        y: { 
                            stacked: isStacked, 
                            beginAtZero: true, 
                            title: { display: true, text: '總工時 (hr)' } 
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: { 
                            position: 'bottom', 
                            labels: { boxWidth: 10, font: { size: 10 } },
                            onClick: (e, legendItem, legend) => {
                                const label = legendItem.text;
                                if (analysisMode === 'PERSON') {
                                    togglePersonSelection(label);
                                } else if (analysisMode === 'PROJECT') {
                                    toggleProjectSelection(label);
                                } else {
                                    if (activeTrendFilter === label) {
                                         activeTrendFilter = null;
                                    } else {
                                         activeTrendFilter = label;
                                    }
                                    setTimeout(() => renderTrendAnalysis(), 0);
                                }
                            }
                        }
                    }
                }
            });

            renderTrendTable(labels, entitiesArr, aggregated, rowStats, isMonthlyMode);
        }

        function renderTrendTable(labels, entities, dataMap, rowStats, isMonthlyMode) {
            const table = document.getElementById('trendTable');
            
            const totals = {};
            entities.forEach(e => {
                totals[e] = labels.reduce((sum, lbl) => sum + (dataMap[lbl][e] || 0), 0);
            });
            const sortedEntities = entities.sort((a,b) => totals[b] - totals[a]);

            const showAvg = (analysisMode === 'GROUP');

            let html = `
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-2 py-2 font-bold text-slate-500">${isMonthlyMode ? '月份' : '日期'}</th>
                        ${sortedEntities.map(e => `<th class="px-2 py-2 text-center text-slate-700 whitespace-nowrap">${e}</th>`).join('')}
                        <th class="px-2 py-2 text-right font-bold text-slate-700">總計</th>
                        ${showAvg ? '<th class="px-2 py-2 text-right font-bold text-indigo-600 bg-indigo-50/30">平均/人</th>' : ''}
                    </tr>
                </thead>
                <tbody>
            `;

            const reversedLabels = [...labels].reverse();
            
            reversedLabels.forEach(lbl => {
                let rowTotal = 0;
                const cells = sortedEntities.map(e => {
                    const val = dataMap[lbl][e] || 0;
                    rowTotal += val;
                    return `<td class="px-2 py-2 text-center border-b border-slate-50 ${val===0 ? 'text-slate-200' : 'text-slate-600 font-mono'}">${val > 0 ? val.toFixed(1) : '-'}</td>`;
                });

                let avgCell = '';
                if (showAvg) {
                    const stats = rowStats[lbl] || { totalHours: 0, uniqueAuthors: new Set() };
                    const count = stats.uniqueAuthors.size;
                    const total = stats.totalHours;
                    const avg = count > 0 ? (total / count).toFixed(1) : '-';
                    const title = count > 0 ? `共 ${count} 人 (${total.toFixed(1)}hr)` : '';
                    avgCell = `<td class="px-2 py-2 text-right font-bold font-mono text-indigo-600 border-b border-slate-50 bg-indigo-50/30" title="${title}">${avg}</td>`;
                }

                html += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-2 py-2 font-bold text-slate-500 border-b border-slate-50 whitespace-nowrap">${lbl}</td>
                        ${cells.join('')}
                        <td class="px-2 py-2 text-right font-bold text-slate-800 border-b border-slate-50 bg-slate-50/50">${rowTotal.toFixed(1)}</td>
                        ${avgCell}
                    </tr>
                `;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        // Added missing Date/History functions
        function loadReportByDate(date, preventTabSwitch = false) {
            currentReportDate = date;
            const picker = document.getElementById('reportDatePicker');
            if(picker) picker.value = date;
            updateHistoryList();

            const db = getDB();
            let data = db[date];

            if (!data) {
                currentDailyData.rows = [];
            } else {
                if (data.rows) {
                    currentDailyData = data;
                } else {
                    currentDailyData.rows = [];
                }
            }
            
            if (preventTabSwitch) {
                if (activeTab === 'OVERVIEW') {
                    renderData();
                } else if (activeTab === 'ANALYSIS') {
                    renderTrendAnalysis();
                }
            } else {
                if (currentDailyData.rows.length > 0) switchTab('OVERVIEW');
                else switchTab('SOURCE');
            }
        }

        function switchToPreviousDay() {
            const currentDate = currentReportDate;
            const dateObj = new Date(currentDate + 'T00:00:00');
            dateObj.setDate(dateObj.getDate() - 1); 
            
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const prevDayISO = `${year}-${month}-${day}`;
            
            loadReportByDate(prevDayISO);
            showToast(`已切換至前日 (${prevDayISO})`);
        }

        function switchToNextDay() {
            const currentDate = currentReportDate;
            const dateObj = new Date(currentDate + 'T00:00:00');
            dateObj.setDate(dateObj.getDate() + 1);
            
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const nextDayISO = `${year}-${month}-${day}`;
            
            loadReportByDate(nextDayISO);
            showToast(`已切換至後日 (${nextDayISO})`);
        }

        function handleDateChange() {
            const newDate = document.getElementById('reportDatePicker').value;
            if(newDate) loadReportByDate(newDate);
        }

        function saveCurrentReport() {
            const date = document.getElementById('reportDatePicker').value;
            if(!date) return showToast('請選擇日期');
            const db = getDB();
            db[date] = currentDailyData;
            saveDB(db);
            showToast('資料已儲存');
        }

        function updateHistoryList() {
            const db = getDB();
            const dates = Object.keys(db).sort().reverse(); 
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '';
            if(dates.length === 0) {
                listEl.innerHTML = '<div class="text-xs text-slate-400 p-2 text-center">尚無紀錄</div>';
                return;
            }
            dates.forEach(date => {
                const item = document.createElement('div');
                item.className = `p-2 rounded cursor-pointer text-sm flex justify-between items-center hover:bg-slate-50 transition ${date === currentReportDate ? 'active-date' : 'text-slate-600'}`;
                item.onclick = () => loadReportByDate(date);
                item.innerHTML = `<span><i class="fa-regular fa-calendar mr-2 opacity-50"></i>${date}</span>`;
                listEl.appendChild(item);
            });
        }

        function exportSettings() {
            if (!globalSettings) return showToast('無設定可匯出');
            const dataStr = JSON.stringify(globalSettings, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily_report_settings_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('設定(組別/專案規則)已匯出');
        }

        function importSettings(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.projectMerges || data.groupMerges) {
                        if (data.projectMerges) globalSettings.projectMerges = data.projectMerges;
                        if (data.groupMerges) globalSettings.groupMerges = data.groupMerges;
                        
                        saveGlobalSettings(); 
                        renderData(); 
                        showToast('設定匯入成功');
                    } else {
                        showToast('無效的設定檔格式');
                    }
                } catch (error) {
                    console.error(error);
                    showToast('檔案格式錯誤或解析失敗');
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
